{% extends "base.html" %}
{% block title %}{{ draft_type }} Transfer History{% endblock %}
{% block content %}

<h1 class="title">{{ draft_type }} - История трансферов</h1>

<!-- Transfer Window Status -->
<div id="transfer-window-status" class="notification is-info">
  <div class="level">
    <div class="level-left">
      <div class="level-item">
        <span id="window-status-text">Загрузка статуса трансферного окна...</span>
      </div>
    </div>
    <div class="level-right">
      <div class="level-item">
        <div class="buttons">
          {% if session.get('godmode') %}
          <button class="button is-small is-success" onclick="showStartWindowModal()">
            Открыть окно
          </button>
          <form method="post" action="{{ url_for('transfers.close_transfer_window', draft_type=draft_type) }}" style="display: inline;">
            <button type="submit" class="button is-small is-danger">Закрыть окно</button>
          </form>
          {% endif %}
          <form method="post" action="{{ url_for('transfers.skip_transfer_turn', draft_type=draft_type) }}" style="display: inline;">
            <button type="submit" class="button is-small is-light">Пропустить ход</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="field is-horizontal">
  <div class="field-label">
    <label class="label">Менеджер:</label>
  </div>
  <div class="field-body">
    <div class="field">
      <div class="control">
        <div class="select">
          <select id="manager-filter" onchange="filterByManager()">
            <option value="">Все менеджеры</option>
            {% for user in users %}
            <option value="{{ user }}" {% if user == selected_manager %}selected{% endif %}>{{ user }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

{% if history %}
<div class="table-container">
  <table class="table is-fullwidth is-striped">
    <thead>
      <tr>
        <th>Дата</th>
        <th>GW</th>
        <th>Менеджер</th>
        <th>Действие</th>
        <th>Игрок OUT</th>
        <th>Игрок IN</th>
      </tr>
    </thead>
    <tbody>
      {% for record in history %}
      <tr>
        <td>{{ record.ts[:16].replace('T', ' ') if record.ts }}</td>
        <td>{{ record.gw or '-' }}</td>
        <td><strong>{{ record.manager }}</strong></td>
        <td>
          {% if record.action == 'pick_transfer_player' %}
            <span class="tag is-info">Подбор трансф. игрока</span>
          {% else %}
            <span class="tag is-warning">Трансфер</span>
          {% endif %}
        </td>
        <td>
          {% if record.out_player %}
            <div class="player-info">
              <strong>{{ record.out_player.fullName }}</strong><br>
              <small class="has-text-grey">{{ record.out_player.clubName }} ({{ record.out_player.position }})</small>
            </div>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if record.in_player %}
            <div class="player-info">
              <strong>{{ record.in_player.fullName }}</strong><br>
              <small class="has-text-grey">{{ record.in_player.clubName }} ({{ record.in_player.position }})</small>
            </div>
          {% elif record.player %}
            <div class="player-info">
              <strong>{{ record.player.fullName }}</strong><br>
              <small class="has-text-grey">{{ record.player.clubName }} ({{ record.player.position }})</small>
            </div>
          {% else %}
            -
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="notification is-info">
  <p>История трансферов пуста</p>
</div>
{% endif %}

<div class="buttons">
  <a href="{{ url_for('home.index') }}" class="button">Назад к главной</a>
  {% if session.get('godmode') %}
  <form method="post" action="{{ url_for('transfers.normalize_players', draft_type=draft_type) }}" style="display: inline;">
    <button type="submit" class="button is-warning" onclick="return confirm('Нормализовать всех игроков для системы трансферов?')">
      Нормализовать игроков
    </button>
  </form>
  {% endif %}
</div>

<style>
.player-info {
  min-width: 150px;
}

.table td {
  vertical-align: middle;
}
</style>

<!-- Start Window Modal -->
{% if session.get('godmode') %}
<style>
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  align-items: center;
  justify-content: center;
}

.modal-dialog {
  background: white;
  border-radius: 8px;
  max-width: 500px;
  width: 90%;
  max-height: 80%;
  overflow-y: auto;
}

.modal-header {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #dbdbdb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: bold;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-body {
  padding: 1.5rem;
}
</style>
<div id="start-window-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" data-close="1"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-title">Открыть трансферное окно</div>
      <button type="button" class="modal-close" data-close="1" aria-label="Закрыть">×</button>
    </div>
    <div class="modal-body">
      <form method="post" action="{{ url_for('transfers.start_transfer_window', draft_type=draft_type) }}">
        <div class="field">
          <label class="label">Gameweek</label>
          <div class="control">
            <input class="input" type="number" name="gw" min="1" max="38" required>
          </div>
          <p class="help">Gameweek после которого открывается трансферное окно</p>
        </div>
        
        <div class="field">
          <label class="label">Порядок менеджеров</label>
          <div class="control">
            <textarea class="textarea" name="managers_order" rows="3" placeholder="Руслан&#10;Андрей&#10;Саша">{% for user in users %}{{ user }}&#10;{% endfor %}</textarea>
          </div>
          <p class="help">По одному менеджеру на строку. Пустое поле = обратный порядок от standings</p>
        </div>
        
        <div class="buttons">
          <button type="submit" class="button is-primary">Открыть окно</button>
          <button type="button" class="button" data-close="1">Отмена</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<script>
function filterByManager() {
  const select = document.getElementById('manager-filter');
  const manager = select.value;
  const currentUrl = new URL(window.location);
  
  if (manager) {
    currentUrl.searchParams.set('manager', manager);
  } else {
    currentUrl.searchParams.delete('manager');
  }
  
  window.location.href = currentUrl.toString();
}

// Load transfer window status
async function loadTransferWindowStatus() {
  try {
    const response = await fetch(`/transfers/{{ draft_type|lower }}/window-status`);
    const data = await response.json();
    
    const statusElement = document.getElementById('window-status-text');
    const containerElement = document.getElementById('transfer-window-status');
    
    if (data.success) {
      if (data.window_active) {
        const window_info = data.window_info;
        const current_manager = data.current_manager;
        
        statusElement.innerHTML = `
          <strong>Трансферное окно активно</strong> - GW${window_info.gw}, 
          раунд ${window_info.current_round}/${window_info.total_rounds}
          ${current_manager ? `<br><span class="tag is-warning">Ход: ${current_manager}</span>` : ''}
        `;
        containerElement.className = 'notification is-success';
      } else {
        statusElement.innerHTML = `
          <strong>Трансферное окно закрыто</strong>
          <br><small>Расписание: ${Object.keys(data.schedule || {}).join(', ') || 'Не задано'}</small>
        `;
        containerElement.className = 'notification is-light';
      }
    } else {
      statusElement.textContent = 'Ошибка загрузки статуса: ' + data.error;
      containerElement.className = 'notification is-danger';
    }
  } catch (error) {
    console.error('Error loading transfer window status:', error);
    document.getElementById('window-status-text').textContent = 'Ошибка загрузки статуса';
    document.getElementById('transfer-window-status').className = 'notification is-danger';
  }
}

function showStartWindowModal() {
  const modal = document.getElementById('start-window-modal');
  modal.setAttribute('aria-hidden', 'false');
  modal.style.display = 'flex';
}

function hideStartWindowModal() {
  const modal = document.getElementById('start-window-modal');
  modal.setAttribute('aria-hidden', 'true');
  modal.style.display = 'none';
}

// Close modal handlers
document.addEventListener('DOMContentLoaded', function() {
  loadTransferWindowStatus();
  
  // Auto-refresh status every 30 seconds
  setInterval(loadTransferWindowStatus, 30000);
  
  // Close modal handlers
  document.querySelectorAll('[data-close="1"]').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.setAttribute('aria-hidden', 'true');
      });
    });
  });
  
  // Escape key handler
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.setAttribute('aria-hidden', 'true');
      });
    }
  });
});
</script>

{% endblock %}
