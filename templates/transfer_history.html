{% extends "base.html" %}
{% block title %}{{ draft_type }} Transfer History{% endblock %}
{% block content %}

<h1 class="title">{{ draft_type }} - –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤</h1>

<!-- Transfer Window Status -->
<div id="transfer-window-status" class="notification is-info">
  <div class="level">
    <div class="level-left">
      <div class="level-item">
        <span id="window-status-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–≥–æ –æ–∫–Ω–∞...</span>
      </div>
    </div>
    <div class="level-right">
      <div class="level-item">
        <div class="buttons">
          {% if session.get('godmode') %}
          <button class="button is-small is-success" onclick="showStartWindowModal()">
            –û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ
          </button>
          <form method="post" action="{{ url_for('transfers.close_transfer_window', draft_type=draft_type) }}" style="display: inline;">
            <button type="submit" class="button is-small is-danger">–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ</button>
          </form>
          <button class="button is-small is-warning" onclick="showFixStateModal()">
            –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          </button>
          {% endif %}
          <form method="post" action="{{ url_for('transfers.skip_transfer_turn', draft_type=draft_type) }}" style="display: inline;">
            <button type="submit" class="button is-small is-light">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ–¥</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Transfer Queue & Current Turn -->
{% if is_window_active and active_window %}
<div class="notification is-light">
  <h4 class="title is-5">üìã –û—á–µ—Ä–µ–¥—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤</h4>
  <div class="content">
    <p><strong>GW {{ active_window.gw }}</strong> - –†–∞—É–Ω–¥ {{ active_window.current_round }}/{{ active_window.total_rounds }}</p>
    
    {% if current_manager %}
    <p><strong>–°–µ–π—á–∞—Å –≤—ã–±–∏—Ä–∞–µ—Ç:</strong> <span class="tag is-warning">üéØ {{ current_manager }}</span></p>
    {% endif %}
    
    
    {% if active_window.managers_order %}
    <div class="content">
      <strong>–û—á–µ—Ä–µ–¥–Ω–æ—Å—Ç—å:</strong>
      <div class="tags">
        {% for manager in active_window.managers_order %}
          {% if manager == current_manager %}
            <span class="tag is-warning is-medium">
              üéØ {{ manager }} (—Å–µ–π—á–∞—Å)
            </span>
          {% else %}
            <span class="tag is-light">{{ manager }}</span>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% else %}
    <div class="has-text-danger">
      <p><strong>DEBUG INFO:</strong></p>
      <p>active_window: {{ active_window }}</p>
      <p>current_manager: {{ current_manager }}</p>
      <p>is_window_active: {{ is_window_active }}</p>
      {% if active_window %}
      <p>managers_order: {{ active_window.managers_order }}</p>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Current User Transfer Interface -->
{% if is_window_active and current_user == current_manager %}
  {% if current_phase == 'out' and user_roster %}
  <div class="notification is-primary">
    <h4 class="title is-5">‚öΩ –í–∞—à —Ö–æ–¥ - TRANSFER OUT: –≤—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –æ—Ç–¥–∞—á–∏</h4>
    
    <div class="columns">
      {% set positions = ['GK', 'DEF', 'MID', 'FWD'] %}
      {% for pos in positions %}
        {% set players_in_pos = user_roster | selectattr('position', 'equalto', pos) | list %}
        {% if players_in_pos %}
        <div class="column">
          <h6 class="subtitle is-6">{{ pos }}</h6>
          <div class="buttons">
            {% for player in players_in_pos %}
            <button class="button is-small is-outlined" 
                    onclick="selectPlayerForTransferOut({{ player.playerId or player.id }}, '{{ player.fullName or player.name }}', '{{ player.clubName or player.club }}', '{{ player.position }}')">
              {{ player.fullName or player.name }}<br>
              <small>{{ player.clubName or player.club }}</small>
            </button>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      {% endfor %}
    </div>
    
    <div class="content">
      <h6 class="subtitle is-6">üìù –§–∞–∑–∞ TRANSFER OUT:</h6>
      <ol>
        <li><strong>–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞</strong> –¥–ª—è –æ—Ç–¥–∞—á–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ</li>
        <li><strong>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—ã–±–æ—Ä</strong> - –∏–≥—Ä–æ–∫ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ transfer out –ø—É–ª</li>
        <li><strong>–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:</strong> TRANSFER IN - –≤—ã–±–æ—Ä –∑–∞–º–µ–Ω—ã</li>
      </ol>
      <p class="has-text-info">
        ‚ÑπÔ∏è <strong>–≠—Ç–∞–ø 1 –∏–∑ 2:</strong> –°–Ω–∞—á–∞–ª–∞ –æ—Ç–¥–∞–π—Ç–µ –∏–≥—Ä–æ–∫–∞, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ–Ω—É
      </p>
    </div>
  </div>
  {% elif current_phase == 'in' %}
  <div class="notification is-success">
    <h4 class="title is-5">üéØ –í–∞—à —Ö–æ–¥ - TRANSFER IN: –≤—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è</h4>
    
    <div class="content">
      <h6 class="subtitle is-6">üìù –§–∞–∑–∞ TRANSFER IN:</h6>
      <ol>
        <li><strong>–ò–≥—Ä–æ–∫ –æ—Ç–¥–∞–Ω</strong> ‚úÖ - —Ç–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ–Ω—É</li>
        <li><strong>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</strong> —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤</li>
        <li><strong>–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞</strong> –∏–∑ transfer out –ø—É–ª–∞</li>
        <li><strong>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—ã–±–æ—Ä</strong> - —Ö–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É</li>
      </ol>
      <p class="has-text-info">
        ‚ÑπÔ∏è <strong>–≠—Ç–∞–ø 2 –∏–∑ 2:</strong> –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ–Ω—É –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
      </p>
      
      <div class="buttons">
        <button class="button is-success is-medium" onclick="showAvailableTransferPlayersForIn()">
          üîÑ –í—ã–±—Ä–∞—Ç—å –∏–≥—Ä–æ–∫–∞ –¥–ª—è TRANSFER IN
        </button>
      </div>
    </div>
  </div>
  {% endif %}
{% elif is_window_active and current_manager %}
<div class="notification is-info">
  <p>üïí <strong>–°–µ–π—á–∞—Å —Ö–æ–¥:</strong> {{ current_manager }} 
    {% if current_phase %}
      <span class="tag is-warning">
        {{ 'TRANSFER OUT' if current_phase == 'out' else 'TRANSFER IN' }}
      </span>
    {% endif %}
  </p>
  <p>–û–∂–∏–¥–∞–π—Ç–µ —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞.</p>
</div>
{% endif %}

<div class="field is-horizontal">
  <div class="field-label">
    <label class="label">–ú–µ–Ω–µ–¥–∂–µ—Ä:</label>
  </div>
  <div class="field-body">
    <div class="field">
      <div class="control">
        <div class="select">
          <select id="manager-filter" onchange="filterByManager()">
            <option value="">–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</option>
            {% for user in users %}
            <option value="{{ user }}" {% if user == selected_manager %}selected{% endif %}>{{ user }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

{% if history %}
<div class="table-container">
  <table class="table is-fullwidth is-striped">
    <thead>
      <tr>
        <th>–î–∞—Ç–∞</th>
        <th>GW</th>
        <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
        <th>–ò–≥—Ä–æ–∫ OUT</th>
        <th>–ò–≥—Ä–æ–∫ IN</th>
      </tr>
    </thead>
    <tbody>
      {% for record in history %}
      <tr>
        <td>{{ record.ts[:16].replace('T', ' ') if record.ts }}</td>
        <td>{{ record.gw or '-' }}</td>
        <td><strong>{{ record.manager }}</strong></td>
        <td>
          {% if record.action == 'pick_transfer_player' %}
            <span class="tag is-info">–ü–æ–¥–±–æ—Ä —Ç—Ä–∞–Ω—Å—Ñ. –∏–≥—Ä–æ–∫–∞</span>
          {% elif record.action == 'transfer_out' %}
            <span class="tag is-primary">Transfer Out</span>
          {% elif record.action == 'transfer_in' %}
            <span class="tag is-success">Transfer In</span>
          {% else %}
            <span class="tag is-warning">–¢—Ä–∞–Ω—Å—Ñ–µ—Ä</span>
          {% endif %}
        </td>
        <td>
          {% if record.out_player %}
            <div class="player-info">
              <strong>{{ record.out_player.fullName }}</strong><br>
              <small class="has-text-grey">{{ record.out_player.clubName }} ({{ record.out_player.position }})</small>
            </div>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if record.in_player %}
            <div class="player-info">
              <strong>{{ record.in_player.fullName }}</strong><br>
              <small class="has-text-grey">{{ record.in_player.clubName }} ({{ record.in_player.position }})</small>
            </div>
          {% elif record.player %}
            <div class="player-info">
              <strong>{{ record.player.fullName }}</strong><br>
              <small class="has-text-grey">{{ record.player.clubName }} ({{ record.player.position }})</small>
            </div>
          {% else %}
            -
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="notification is-info">
  <p>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤ –ø—É—Å—Ç–∞</p>
</div>
{% endif %}

<div class="buttons">
  <a href="{{ url_for('home.index') }}" class="button">–ù–∞–∑–∞–¥ –∫ –≥–ª–∞–≤–Ω–æ–π</a>
  {% if session.get('godmode') %}
  <form method="post" action="{{ url_for('transfers.normalize_players', draft_type=draft_type) }}" style="display: inline;">
    <button type="submit" class="button is-warning" onclick="return confirm('–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤?')">
      –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤
    </button>
  </form>
  {% endif %}
</div>

<style>
.player-info {
  min-width: 150px;
}

.table td {
  vertical-align: middle;
}
</style>

<!-- Start Window Modal -->
{% if session.get('godmode') %}
<style>
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  align-items: center;
  justify-content: center;
}

.modal-dialog {
  background: white;
  border-radius: 8px;
  max-width: 500px;
  width: 90%;
  max-height: 80%;
  overflow-y: auto;
}

.modal-header {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #dbdbdb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: bold;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-body {
  padding: 1.5rem;
}
</style>
<div id="start-window-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" data-close="1"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-title">–û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ</div>
      <button type="button" class="modal-close" data-close="1" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    </div>
    <div class="modal-body">
      <form method="post" action="{{ url_for('transfers.start_transfer_window', draft_type=draft_type) }}">
        <div class="field">
          <label class="label">Gameweek</label>
          <div class="control">
            <input class="input" type="number" name="gw" min="1" max="38" required>
          </div>
          <p class="help">Gameweek –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ</p>
        </div>
        
        <div class="field">
          <label class="label">–ü–æ—Ä—è–¥–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</label>
          <div class="control">
            <textarea class="textarea" name="managers_order" rows="3" placeholder="–†—É—Å–ª–∞–Ω&#10;–ê–Ω–¥—Ä–µ–π&#10;–°–∞—à–∞">{% for user in users %}{{ user }}&#10;{% endfor %}</textarea>
          </div>
          <p class="help">–ü–æ –æ–¥–Ω–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É –Ω–∞ —Å—Ç—Ä–æ–∫—É. –ü—É—Å—Ç–æ–µ –ø–æ–ª–µ = –æ–±—Ä–∞—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ—Ç standings</p>
        </div>
        
        <div class="buttons">
          <button type="submit" class="button is-primary">–û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ</button>
          <button type="button" class="button" data-close="1">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="fix-state-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" data-close-fix="1"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-title">–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞</div>
      <button type="button" class="modal-close" data-close-fix="1" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    </div>
    <div class="modal-body">
      <form method="post" action="{{ url_for('transfers.fix_transfer_state', draft_type=draft_type) }}">
        <div class="field">
          <label class="label">–ú–µ–Ω–µ–¥–∂–µ—Ä</label>
          <div class="control">
            <div class="select">
              <select name="manager" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</option>
                {% for user in users %}
                <option value="{{ user }}">{{ user }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        
        <div class="field">
          <label class="label">–§–∞–∑–∞</label>
          <div class="control">
            <div class="select">
              <select name="phase" required>
                <option value="out">Transfer Out</option>
                <option value="in">Transfer In</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="buttons">
          <button type="submit" class="button is-warning">–ò—Å–ø—Ä–∞–≤–∏—Ç—å</button>
          <button type="button" class="button" data-close-fix="1">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<script>
function filterByManager() {
  const select = document.getElementById('manager-filter');
  const manager = select.value;
  const currentUrl = new URL(window.location);
  
  if (manager) {
    currentUrl.searchParams.set('manager', manager);
  } else {
    currentUrl.searchParams.delete('manager');
  }
  
  window.location.href = currentUrl.toString();
}

// Load transfer window status
async function loadTransferWindowStatus() {
  try {
    const response = await fetch(`/transfers/{{ draft_type|lower }}/window-status`);
    const data = await response.json();
    
    const statusElement = document.getElementById('window-status-text');
    const containerElement = document.getElementById('transfer-window-status');
    
    if (data.success) {
      if (data.window_active) {
        const window_info = data.window_info;
        const current_manager = data.current_manager;
        const current_phase = data.current_phase;
        
        statusElement.innerHTML = `
          <strong>–¢—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ</strong> - GW${window_info.gw}, 
          —Ä–∞—É–Ω–¥ ${window_info.current_round}/${window_info.total_rounds}
          ${current_manager ? `<br><span class="tag is-warning">–•–æ–¥: ${current_manager}</span>` : ''}
          ${current_phase ? `<span class="tag ${current_phase === 'out' ? 'is-primary' : 'is-success'}">${current_phase === 'out' ? 'TRANSFER OUT' : 'TRANSFER IN'}</span>` : ''}
        `;
        containerElement.className = 'notification is-success';
      } else {
        statusElement.innerHTML = `
          <strong>–¢—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ</strong>
          <br><small>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: ${Object.keys(data.schedule || {}).join(', ') || '–ù–µ –∑–∞–¥–∞–Ω–æ'}</small>
        `;
        containerElement.className = 'notification is-light';
      }
    } else {
      statusElement.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + data.error;
      containerElement.className = 'notification is-danger';
    }
  } catch (error) {
    console.error('Error loading transfer window status:', error);
    document.getElementById('window-status-text').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞';
    document.getElementById('transfer-window-status').className = 'notification is-danger';
  }
}

function showStartWindowModal() {
  const modal = document.getElementById('start-window-modal');
  modal.setAttribute('aria-hidden', 'false');
  modal.style.display = 'flex';
}

function hideStartWindowModal() {
  const modal = document.getElementById('start-window-modal');
  modal.setAttribute('aria-hidden', 'true');
  modal.style.display = 'none';
}

function showFixStateModal() {
  const modal = document.getElementById('fix-state-modal');
  modal.setAttribute('aria-hidden', 'false');
  modal.style.display = 'flex';
}

function hideFixStateModal() {
  const modal = document.getElementById('fix-state-modal');
  modal.setAttribute('aria-hidden', 'true');
  modal.style.display = 'none';
}

// Close modal handlers
document.addEventListener('DOMContentLoaded', function() {
  loadTransferWindowStatus();
  
  // Auto-refresh status every 30 seconds
  setInterval(loadTransferWindowStatus, 30000);
  
  // Close modal handlers
  document.querySelectorAll('[data-close="1"]').forEach(el => {
    el.addEventListener('click', () => {
      hideStartWindowModal();
    });
  });
  
  document.querySelectorAll('[data-close-fix="1"]').forEach(el => {
    el.addEventListener('click', () => {
      hideFixStateModal();
    });
  });
  
  // Close on backdrop click
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-backdrop')) {
      hideStartWindowModal();
      hideFixStateModal();
    }
  });
  
  // Escape key handler
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      hideStartWindowModal();
      hideFixStateModal();
    }
  });
});

// Transfer Out Functions
function selectPlayerForTransferOut(playerId, playerName, playerClub, playerPosition) {
  if (confirm(`–û—Ç–¥–∞—Ç—å –∏–≥—Ä–æ–∫–∞ ${playerName} (${playerClub}, ${playerPosition}) –≤ transfer out –ø—É–ª?`)) {
    // Show loading state
    const loadingNotification = document.createElement('div');
    loadingNotification.className = 'notification is-info';
    loadingNotification.innerHTML = '<p>‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–≥—Ä–æ–∫–∞ –≤ transfer out –ø—É–ª...</p>';
    document.body.insertBefore(loadingNotification, document.body.firstChild);
    
    fetch(`/transfers/{{ draft_type|lower }}/pick-transfer-player`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        'player_id': playerId,
        'player_name': playerName,
        'player_club': playerClub,
        'player_position': playerPosition
      })
    })
    .then(response => response.json())
    .then(data => {
      // Remove loading notification
      if (loadingNotification.parentNode) {
        loadingNotification.parentNode.removeChild(loadingNotification);
      }
      
      if (data.success) {
        // Reload page to show transfer in phase
        window.location.reload();
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–≥—Ä–æ–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    })
    .catch(error => {
      // Remove loading notification
      if (loadingNotification.parentNode) {
        loadingNotification.parentNode.removeChild(loadingNotification);
      }
      console.error('Error:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–≥—Ä–æ–∫–∞: ' + error.message);
    });
  }
}

function showAvailableTransferPlayers(outPlayerId) {
  // Create modal for selecting replacement player
  const modal = document.createElement('div');
  modal.id = 'transfer-replacement-modal';
  modal.className = 'modal';
  modal.style.display = 'flex';
  modal.innerHTML = `
    <div class="modal-backdrop" onclick="closeTransferReplacementModal()"></div>
    <div class="modal-dialog" style="max-width: 800px;">
      <div class="modal-header">
        <div class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ–Ω—É –∏–∑ transfer out –ø—É–ª–∞</div>
        <button type="button" class="modal-close" onclick="closeTransferReplacementModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div id="available-players-loading">
          <p>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤...</p>
        </div>
        <div id="available-players-list" style="display: none;">
          <div id="available-players-content"></div>
        </div>
        <div id="available-players-empty" style="display: none;">
          <p>üòî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –≤ transfer out –ø—É–ª–µ</p>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Load available transfer players
  fetch(`/transfers/{{ draft_type|lower }}/available-players`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('available-players-loading').style.display = 'none';
      
      if (data.success && data.players && data.players.length > 0) {
        displayAvailablePlayers(data.players, outPlayerId);
        document.getElementById('available-players-list').style.display = 'block';
      } else {
        document.getElementById('available-players-empty').style.display = 'block';
      }
    })
    .catch(error => {
      console.error('Error loading available players:', error);
      document.getElementById('available-players-loading').innerHTML = 
        '<p class="has-text-danger">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä–æ–∫–æ–≤</p>';
    });
}

function displayAvailablePlayers(players, outPlayerId) {
  const container = document.getElementById('available-players-content');
  
  // Group players by position
  const positions = {};
  players.forEach(player => {
    const pos = player.position || 'Unknown';
    if (!positions[pos]) positions[pos] = [];
    positions[pos].push(player);
  });
  
  let html = '<div class="columns is-multiline">';
  Object.keys(positions).forEach(pos => {
    html += `<div class="column is-half">
      <h6 class="subtitle is-6">${pos}</h6>
      <div class="buttons">`;
    
    positions[pos].forEach(player => {
      html += `<button class="button is-small is-primary is-outlined" 
                      onclick="selectReplacementPlayer(${outPlayerId}, ${player.playerId || player.id}, '${player.fullName}', '${player.clubName}', '${player.position}')">
                 ${player.fullName}<br>
                 <small>${player.clubName}</small>
               </button>`;
    });
    
    html += '</div></div>';
  });
  html += '</div>';
  
  container.innerHTML = html;
}

function selectReplacementPlayer(outPlayerId, inPlayerId, inPlayerName, inPlayerClub, inPlayerPosition) {
  if (confirm(`–í–∑—è—Ç—å –∏–≥—Ä–æ–∫–∞ ${inPlayerName} (${inPlayerClub}, ${inPlayerPosition}) –≤ –∫–æ–º–∞–Ω–¥—É?`)) {
    // Execute the transfer
    fetch(`/transfers/{{ draft_type|lower }}/execute`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        'out_player_id': outPlayerId,
        'in_player_id': inPlayerId,
        'in_player_name': inPlayerName,
        'in_player_club': inPlayerClub,
        'in_player_position': inPlayerPosition
      })
    })
    .then(response => {
      if (response.redirected) {
        window.location.href = response.url;
      } else {
        return response.json();
      }
    })
    .then(data => {
      if (data && !data.success) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      } else {
        // Success - reload the page
        window.location.reload();
      }
    })
    .catch(error => {
      console.error('Error executing transfer:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞: ' + error.message);
    });
  }
}

// Transfer In Functions (for new two-phase system)
function showAvailableTransferPlayersForIn() {
  // Create modal for selecting transfer in player
  const modal = document.createElement('div');
  modal.id = 'transfer-in-modal';
  modal.className = 'modal';
  modal.style.display = 'flex';
  modal.innerHTML = \`
    <div class="modal-backdrop" onclick="closeTransferInModal()"></div>
    <div class="modal-dialog" style="max-width: 800px;">
      <div class="modal-header">
        <div class="modal-title">TRANSFER IN: –í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è</div>
        <button type="button" class="modal-close" onclick="closeTransferInModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div id="transfer-in-loading">
          <p>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤...</p>
        </div>
        <div id="transfer-in-list" style="display: none;">
          <div id="transfer-in-content"></div>
        </div>
        <div id="transfer-in-empty" style="display: none;">
          <p>üòî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –≤ transfer out –ø—É–ª–µ</p>
        </div>
      </div>
    </div>
  \`;
  
  document.body.appendChild(modal);
  
  // Load available transfer players
  fetch(\`/transfers/{{ draft_type|lower }}/available-players\`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('transfer-in-loading').style.display = 'none';
      
      if (data.success && data.players && data.players.length > 0) {
        displayTransferInPlayers(data.players);
        document.getElementById('transfer-in-list').style.display = 'block';
      } else {
        document.getElementById('transfer-in-empty').style.display = 'block';
      }
    })
    .catch(error => {
      console.error('Error loading available players:', error);
      document.getElementById('transfer-in-loading').innerHTML = 
        '<p class="has-text-danger">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä–æ–∫–æ–≤</p>';
    });
}

function displayTransferInPlayers(players) {
  const container = document.getElementById('transfer-in-content');
  
  // Group players by position
  const positions = {};
  players.forEach(player => {
    const pos = player.position || 'Unknown';
    if (!positions[pos]) positions[pos] = [];
    positions[pos].push(player);
  });
  
  let html = '<div class="columns is-multiline">';
  Object.keys(positions).forEach(pos => {
    html += \`<div class="column is-half">
      <h6 class="subtitle is-6">\${pos}</h6>
      <div class="buttons">\`;
    
    positions[pos].forEach(player => {
      html += \`<button class="button is-small is-success is-outlined" 
                      onclick="selectTransferInPlayer(\${player.playerId || player.id}, '\${player.fullName}', '\${player.clubName}', '\${player.position}')">
                 \${player.fullName}<br>
                 <small>\${player.clubName}</small>
               </button>\`;
    });
    
    html += '</div></div>';
  });
  html += '</div>';
  
  container.innerHTML = html;
}

function selectTransferInPlayer(inPlayerId, inPlayerName, inPlayerClub, inPlayerPosition) {
  if (confirm(\`–í–∑—è—Ç—å –∏–≥—Ä–æ–∫–∞ \${inPlayerName} (\${inPlayerClub}, \${inPlayerPosition}) –≤ –∫–æ–º–∞–Ω–¥—É?\`)) {
    // Execute the transfer in
    fetch(\`/transfers/{{ draft_type|lower }}/transfer-player-in\`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        'player_id': inPlayerId
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Success - reload the page
        window.location.reload();
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
    })
    .catch(error => {
      console.error('Error executing transfer in:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞: ' + error.message);
    });
  }
}

function closeTransferInModal() {
  const modal = document.getElementById('transfer-in-modal');
  if (modal) {
    modal.parentNode.removeChild(modal);
  }
}

function closeTransferReplacementModal() {
  const modal = document.getElementById('transfer-replacement-modal');
  if (modal) {
    modal.parentNode.removeChild(modal);
  }
}
</script>

{% endblock %}
