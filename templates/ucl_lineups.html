{% extends "base.html" %}
{% block title %}UCL Лайнапы{% endblock %}
{% block content %}
<h1 class="title">UCL Лайнапы MD{{ md }}</h1>
{% if session.get('godmode') %}
<div class="mb-3">
  <form method="post" action="{{ url_for('ucl.cache_stats') }}" style="display:inline-block;">
    <button class="button is-link" type="submit"{% if stats_refresh_running %} disabled{% endif %}>Обновить статку</button>
  </form>
  {% if stats_refresh_running %}
    <span class="tag is-info" style="margin-left:8px;">Обновление выполняется…</span>
  {% endif %}
</div>
{% endif %}
<form method="get" class="mb-4">
  <label class="label">Matchday</label>
  <div class="field has-addons">
    <div class="control"><input class="input" type="number" name="md" value="{{ md }}" min="1" style="width:90px"/></div>
    <div class="control"><button class="button is-link" type="submit">Показать</button></div>
  </div>
</form>
<div id="ucl-lineups-container">Загрузка...</div>

<div id="ucl-points-modal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Статистика</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body" id="ucl-points-modal-body"></section>
    <footer class="modal-card-foot">
      <button class="button" id="ucl-points-modal-close">Закрыть</button>
    </footer>
  </div>
</div>

<style>
  #ucl-lineups-container { display:inline-block; }
  #ucl-lineups-container .tabs { display:flex; }
  #ucl-lineups-container .tabs ul { flex-grow:0; }
  .ucl-player-row { display:flex; justify-content:space-between; align-items:center; white-space:nowrap; }
  .ucl-player-name { overflow:hidden; text-overflow:ellipsis; margin-right:6px; }
  .ucl-points-box { background:#add8e6; border-radius:4px; padding:0 6px; min-width:2.4em; text-align:center; cursor:pointer; }
  .ucl-team-logo { width:25px; height:25px; object-fit:contain; margin-right:6px; }
  .ucl-player-portrait { width:25px; height:25px; border-radius:50%; object-fit:cover; margin-right:20px; }
  .ucl-player-info { display:flex; align-items:center; overflow:hidden; }
  .ucl-player-text { overflow:hidden; text-overflow:ellipsis; }
  .ucl-player-matchdays { font-size:0.75rem; margin-left:8px; background:#e6f2ff; border-radius:4px; padding:0 6px; color:#1d4ed8; flex-shrink:0; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const MD = {{ md }};
  const container = document.getElementById('ucl-lineups-container');
  container.style.display = 'inline-block';
  const modal = document.getElementById('ucl-points-modal');
  const modalBody = document.getElementById('ucl-points-modal-body');
  const closeModal = () => modal.classList.remove('is-active');
  modal.querySelector('.modal-background').addEventListener('click', closeModal);
  modal.querySelector('.delete').addEventListener('click', closeModal);
  document.getElementById('ucl-points-modal-close').addEventListener('click', closeModal);
  const url = `{{ url_for('ucl.ucl_lineups_data') }}?md={{ md }}`;

  const posOrder = {
    GK: 0, Goalkeeper: 0,
    DEF: 1, Defender: 1,
    MID: 2, Midfielder: 2,
    FWD: 3, Forward: 3
  };

  const STAT_FIELDS = [
    { label: 'Очки', pointsKey: 'tPoints' },
    { label: 'Голы', rawKey: 'gS', pointsKey: 'gS' },
    { label: 'Ассисты', rawKey: 'gA', pointsKey: 'gA' },
    { label: 'Сухие матчи', rawKey: 'cS', pointsKey: 'cS' },
    { label: 'Минуты', rawKey: 'oF', pointsKey: 'oF' },
    { label: 'Игрок Матча', rawKey: 'mOM', pointsKey: 'mOM' },
    { label: 'Сэйвы', rawKey: 'sS', pointsKey: 'sS' },
    { label: 'Возвраты', rawKey: 'bR', pointsKey: 'bR' },
    { label: 'Голов пропущено', rawKey: 'gC', pointsKey: 'gC' },
    { label: 'Заработанные пенальти', rawKey: 'pE', pointsKey: 'pE' },
    { label: 'Реализованные пенальти', rawKey: 'pS', pointsKey: 'pS' },
    { label: 'Промахи с пенальти', rawKey: 'pM', pointsKey: 'pM' },
    { label: 'Пропущенные пенальти', rawKey: 'pC', pointsKey: 'pC' },
    { label: 'Жёлтые', rawKey: 'yC', pointsKey: 'yC' },
    { label: 'Красные', rawKey: 'rC', pointsKey: 'rC' },
    { label: 'Автоголы', rawKey: 'oG', pointsKey: 'oG' },
    { label: 'Голы из-за штрафной', rawKey: 'gOB', pointsKey: 'gOB' },
  ];

  const showPopup = player => {
    modalBody.innerHTML = '';
    modal.querySelector('.modal-card-title').textContent = player.name;
    const stat = player.stat || {};
    const rawStats = (stat.stats && typeof stat.stats === 'object') ? stat.stats : {};
    const points = (stat.points && typeof stat.points === 'object') ? stat.points : {};

    if (Array.isArray(player.matchdays) && player.matchdays.length) {
      const mdInfo = document.createElement('p');
      mdInfo.className = 'has-text-grey is-size-7';
      mdInfo.textContent = `Туры: ${player.matchdays.join(', ')}`;
      modalBody.appendChild(mdInfo);
    }

    const getNumber = value => {
      const num = Number(value);
      return Number.isFinite(num) ? num : 0;
    };

    // Создаём контейнер для изображений и таблицы
    const contentContainer = document.createElement('div');
    contentContainer.style.display = 'flex';
    contentContainer.style.alignItems = 'flex-start';
    contentContainer.style.gap = '20px';

    // Контейнер для изображений
    const imagesContainer = document.createElement('div');
    imagesContainer.style.display = 'flex';
    imagesContainer.style.flexDirection = 'column';
    imagesContainer.style.alignItems = 'center';
    imagesContainer.style.gap = '10px';
    imagesContainer.style.minWidth = '100px';

    // Лого клуба
    const clubLogo = document.createElement('img');
    clubLogo.style.width = '80px';
    clubLogo.style.height = '80px';
    clubLogo.style.objectFit = 'contain';
    if (player.teamId) {
      clubLogo.src = `https://img.uefa.com/imgml/TP/teams/logos/140x140/${player.teamId}.png`;
    } else {
      clubLogo.src = 'https://img.uefa.com/imgml/TP/teams/logos/140x140/0.png';
    }
    clubLogo.alt = player.club || 'Club';

    // Портрет игрока  
    const playerPortrait = document.createElement('img');
    playerPortrait.style.width = '80px';
    playerPortrait.style.height = '80px';
    playerPortrait.style.borderRadius = '8px';
    playerPortrait.style.objectFit = 'cover';
    if (player.playerId) {
      playerPortrait.src = `https://img.uefa.com/imgml/TP/players/1/2026/324x324/${player.playerId}.jpg`;
    } else {
      playerPortrait.src = 'https://gaming.uefa.com/en/uclfantasy/static-assets/ucl2020/images/default_player@2x.png';
    }
    playerPortrait.onerror = () => {
      playerPortrait.src = 'https://gaming.uefa.com/en/uclfantasy/static-assets/ucl2020/images/default_player@2x.png';
    };
    playerPortrait.alt = player.name;

    imagesContainer.appendChild(clubLogo);
    imagesContainer.appendChild(playerPortrait);

    // Контейнер для таблицы
    const tableContainer = document.createElement('div');
    tableContainer.style.flex = '1';
    
    const table = document.createElement('table');
    table.className = 'table is-narrow';
    const tbody = document.createElement('tbody');

    STAT_FIELDS.forEach(field => {
      const rawValue = field.rawKey ? getNumber(rawStats[field.rawKey]) : null;
      let pointsValue = 0;
      if (field.pointsKey === 'tPoints') {
        pointsValue = getNumber(stat.tPoints);
      } else if (field.pointsKey) {
        pointsValue = getNumber(points[field.pointsKey]);
      } else if (field.rawKey) {
        pointsValue = rawValue ?? 0;
      }

      // Показать строку если это Очки или Минуты, или если есть ненулевые значения
      const shouldShow = field.pointsKey === 'tPoints' || 
                        field.rawKey === 'oF' || 
                        (rawValue !== null && rawValue !== 0) || 
                        pointsValue !== 0;

      if (shouldShow) {
        const tr = document.createElement('tr');
        const tdL = document.createElement('td');
        tdL.textContent = field.rawKey ? `${field.label} (${rawValue ?? 0})` : field.label;
        const tdV = document.createElement('td');
        tdV.className = 'has-text-right';
        tdV.textContent = pointsValue;
        tr.appendChild(tdL);
        tr.appendChild(tdV);
        tbody.appendChild(tr);
      }
    });

    table.appendChild(tbody);
    tableContainer.appendChild(table);
    
    contentContainer.appendChild(imagesContainer);
    contentContainer.appendChild(tableContainer);
    modalBody.appendChild(contentContainer);
    
    modal.classList.add('is-active');
  };

  const render = data => {
    const rawManagers = data.managers || [];
    const lineups = data.lineups || {};
    
    // Separate regular managers from special teams
    const regularManagers = rawManagers.filter(m => m !== 'Team of The MD' && m !== 'Непикнутые гении');
    const specialTeams = rawManagers.filter(m => m === 'Team of The MD' || m === 'Непикнутые гении');
    
    // Sort regular managers by total points
    const managers = regularManagers.slice().sort((a, b) => {
      const totalA = Number(lineups[a] && lineups[a].total) || 0;
      const totalB = Number(lineups[b] && lineups[b].total) || 0;
      return totalB - totalA;
    });
    
    // Add special teams at the end
    const allManagers = managers.concat(specialTeams);
    
    container.innerHTML = '';

    const tabs = document.createElement('div');
    tabs.className = 'tabs';
    const ul = document.createElement('ul');
    ul.style.flexGrow = '0';
    tabs.appendChild(ul);

    const contents = document.createElement('div');
    contents.style.display = 'block';
    const blocks = [];

    allManagers.forEach((manager, idx) => {
      const li = document.createElement('li');
      if (idx === 0) li.classList.add('is-active');
      const a = document.createElement('a');
      const strong = document.createElement('strong');
      strong.textContent = manager;
      a.appendChild(strong);
      const total = lineups[manager] && lineups[manager].total;
      if (total !== undefined && total !== null) {
        const badge = document.createElement('span');
        badge.style.backgroundColor = '#006400';
        badge.style.color = 'white';
        badge.style.padding = '0 4px';
        badge.style.borderRadius = '3px';
        badge.style.marginLeft = '4px';
        badge.textContent = total;
        a.appendChild(badge);
      }
      li.appendChild(a);
      ul.appendChild(li);

      const block = document.createElement('div');
      block.style.display = idx === 0 ? 'block' : 'none';
      const players = lineups[manager] && Array.isArray(lineups[manager].players)
        ? lineups[manager].players.slice()
        : [];
      const benchPlayers = lineups[manager] && Array.isArray(lineups[manager].bench)
        ? lineups[manager].bench.slice()
        : [];
      
      // Special styling for special teams
      let c1, c2;
      if (manager === 'Team of The MD') {
        c1 = 'hsl(270, 70%, 95%)'; // Light purple
        c2 = 'hsl(270, 70%, 85%)'; // Medium purple
      } else if (manager === 'Непикнутые гении') {
        c1 = 'hsl(300, 70%, 95%)'; // Light magenta
        c2 = 'hsl(300, 70%, 85%)'; // Medium magenta
      } else {
        const hue = idx * 60;
        c1 = `hsl(${hue}, 70%, 90%)`;
        c2 = `hsl(${hue}, 70%, 80%)`;
      }
      const normalizePos = (pos) => {
        const upper = (pos || '').toString().toUpperCase();
        if (upper.startsWith('GOAL')) return 'GK';
        if (upper.startsWith('DEF')) return 'DEF';
        if (upper.startsWith('MID')) return 'MID';
        if (upper.startsWith('FWD')) return 'FWD';
        if (upper === 'GK' || upper === 'GKP') return 'GK';
        if (upper === 'GKP') return 'GK';
        return upper;
      };
      const order = ['GK', 'DEF', 'MID', 'FWD', 'OTHER'];
      let rowIndex = 0;
      const renderPlayersByPosition = (items, titleText = '') => {
        if (!Array.isArray(items) || !items.length) return;
        if (titleText) {
          if (rowIndex > 0) {
            const hr = document.createElement('hr');
            hr.className = 'my-2';
            block.appendChild(hr);
          }
          const title = document.createElement('div');
          title.style.fontWeight = 'bold';
          title.style.marginBottom = '8px';
          title.textContent = titleText;
          block.appendChild(title);
        }
        const grouped = { GK: [], DEF: [], MID: [], FWD: [], OTHER: [] };
        items.forEach(player => {
          const key = normalizePos(player.pos);
          if (grouped[key]) {
            grouped[key].push(player);
          } else {
            grouped.OTHER.push(player);
          }
        });

        order.forEach((posKey) => {
          const group = grouped[posKey];
          if (!group.length) return;
          if (rowIndex > 0 && !titleText) {
            const hr = document.createElement('hr');
            hr.className = 'my-1';
            block.appendChild(hr);
          }
          group.forEach((player) => {
            const row = document.createElement('div');
            row.className = 'ucl-player-row';
            row.style.backgroundColor = rowIndex % 2 === 0 ? c1 : c2;
            const infoWrap = document.createElement('span');
            infoWrap.className = 'ucl-player-info';
            const logo = document.createElement('img');
            logo.className = 'ucl-team-logo';
            if (player.teamId) {
              logo.src = `https://img.uefa.com/imgml/TP/teams/logos/140x140/${player.teamId}.png`;
            } else {
              logo.src = 'https://img.uefa.com/imgml/TP/teams/logos/140x140/0.png';
            }
            logo.alt = player.club || '';
            infoWrap.appendChild(logo);

            const portrait = document.createElement('img');
            portrait.className = 'ucl-player-portrait';
            if (player.playerId) {
              portrait.src = `https://img.uefa.com/imgml/TP/players/1/2026/324x324/${player.playerId}.jpg`;
            } else {
              portrait.src = 'https://gaming.uefa.com/en/uclfantasy/static-assets/ucl2020/images/default_player@2x.png';
            }
            portrait.onerror = () => {
              portrait.src = 'https://gaming.uefa.com/en/uclfantasy/static-assets/ucl2020/images/default_player@2x.png';
            };
            portrait.alt = player.name;
            infoWrap.appendChild(portrait);
            const spanName = document.createElement('span');
            spanName.className = player.teamId ? 'ucl-player-text' : 'ucl-player-name';
            spanName.textContent = player.name;
            if (player.club && !player.teamId) {
              spanName.textContent += ` (${player.club})`;
            }
            infoWrap.appendChild(spanName);

            if (manager === "Team of The MD" && player.manager) {
              const managerSpan = document.createElement('span');
              managerSpan.className = 'ucl-player-matchdays';
              managerSpan.textContent = player.manager;
              infoWrap.appendChild(managerSpan);
            } else if (manager !== "Team of The MD" && manager !== "Непикнутые гении" && Array.isArray(player.matchdays) && player.matchdays.length) {
              const spanMatchdays = document.createElement('span');
              spanMatchdays.className = 'ucl-player-matchdays';
              spanMatchdays.textContent = `Туры: ${player.matchdays.join(', ')}`;
              infoWrap.appendChild(spanMatchdays);
            }
            const spanPoints = document.createElement('span');
            spanPoints.className = 'ucl-points-box';
            spanPoints.textContent = player.points;
            spanPoints.addEventListener('click', () => showPopup(player));
            row.appendChild(infoWrap);
            row.appendChild(spanPoints);
            block.appendChild(row);
            rowIndex += 1;
          });
        });
      };

      renderPlayersByPosition(players, '');

      if (benchPlayers.length && manager !== 'Team of The MD' && manager !== 'Непикнутые гении') {
        renderPlayersByPosition(benchPlayers, `Скамейка (${benchPlayers.length})`);
      }
      
      // Add available clubs section
      const availableClubs = lineups[manager] && Array.isArray(lineups[manager].available_clubs)
        ? lineups[manager].available_clubs
        : [];
      if (availableClubs.length > 0) {
        const hr = document.createElement('hr');
        hr.className = 'my-2';
        block.appendChild(hr);
        
        const clubsLabel = document.createElement('div');
        clubsLabel.style.fontWeight = 'bold';
        clubsLabel.style.marginBottom = '8px';
        // For optimal teams, show "Незадействованные клубы:" instead of "Доступные клубы:"
        if (manager === "Team of The MD" || manager === "Непикнутые гении") {
          clubsLabel.textContent = 'Незадействованные клубы:';
        } else {
          clubsLabel.textContent = 'Доступные клубы:';
        }
        block.appendChild(clubsLabel);
        
        const clubsContainer = document.createElement('div');
        clubsContainer.style.display = 'flex';
        clubsContainer.style.flexWrap = 'wrap';
        clubsContainer.style.gap = '8px';
        clubsContainer.style.marginBottom = '16px';
        
        availableClubs.forEach(club => {
          const clubLogo = document.createElement('img');
          clubLogo.className = 'ucl-team-logo';
          clubLogo.style.width = '30px';
          clubLogo.style.height = '30px';
          if (club.teamId) {
            clubLogo.src = `https://img.uefa.com/imgml/TP/teams/logos/140x140/${club.teamId}.png`;
          } else {
            clubLogo.src = 'https://img.uefa.com/imgml/TP/teams/logos/140x140/0.png';
          }
          clubLogo.alt = club.clubName || '';
          clubLogo.title = club.clubName || '';
          clubsContainer.appendChild(clubLogo);
        });
        
        block.appendChild(clubsContainer);
      }
      
      contents.appendChild(block);
      blocks.push(block);

      li.addEventListener('click', () => {
        tabs.querySelectorAll('li').forEach(el => el.classList.remove('is-active'));
        li.classList.add('is-active');
        blocks.forEach((div, divIdx) => {
          div.style.display = divIdx === idx ? 'block' : 'none';
        });
      });
    });

    container.appendChild(tabs);
    container.appendChild(contents);
  };

  fetch(url)
    .then(resp => resp.json())
    .then(render)
    .catch(() => {
      container.textContent = 'Не удалось загрузить лайнапы';
    });
});
</script>
{% endblock %}
