{% extends "base.html" %}
{% block title %}UCL Результаты{% endblock %}
{% block content %}
<h1 class="title">UCL Результаты</h1>
{% if session.get('godmode') %}
<div class="mb-4">
  <div class="field has-addons">
    <div class="control">
      <input class="input" type="number" id="finish-md-input" placeholder="Номер MD" min="1" max="8" style="width:120px">
    </div>
    <div class="control">
      <button class="button is-success" id="finish-md-btn">Закончить тур</button>
    </div>
  </div>
  <div id="finished-status" class="mt-2"></div>
</div>
{% endif %}
<div id="lineups-container">Загрузка...</div>

<div id="points-modal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Очки по MD</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body" id="points-modal-body"></section>
    <footer class="modal-card-foot">
      <button class="button" id="points-modal-close">Закрыть</button>
    </footer>
  </div>
</div>

<style>
  #lineups-container { display:inline-block; }
  #lineups-container .tabs { display:flex; }
  #lineups-container .tabs ul { flex-grow:0; }
  .player-row { display:flex; justify-content:space-between; align-items:center; white-space:nowrap; }
  .player-name { overflow:hidden; text-overflow:ellipsis; margin-right:6px; }
  .points-box { background:#add8e6; border-radius:4px; padding:0 6px; min-width:2.4em; text-align:center; cursor:pointer; }
  .team-logo { width:25px; height:25px; object-fit:contain; margin-right:6px; }
  .player-portrait { width:25px; height:25px; border-radius:50%; object-fit:cover; margin-right:20px; }
  .player-info { display:flex; align-items:center; overflow:hidden; }
  .player-text { overflow:hidden; text-overflow:ellipsis; }
  .player-matchdays { font-size:0.75rem; margin-left:8px; background:#e6f2ff; border-radius:4px; padding:0 6px; color:#1d4ed8; flex-shrink:0; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const container = document.getElementById('lineups-container');
  container.style.display = 'inline-block';
  const modal = document.getElementById('points-modal');
  const modalBody = document.getElementById('points-modal-body');
  const closeModal = () => modal.classList.remove('is-active');
  modal.querySelector('.modal-background').addEventListener('click', closeModal);
  modal.querySelector('.delete').addEventListener('click', closeModal);
  document.getElementById('points-modal-close').addEventListener('click', closeModal);
  const url = `{{ url_for('ucl.ucl_results_data') }}`;

  const posOrder = { GK:0, DEF:1, MID:2, FWD:3 };

  // Godmode functionality
  {% if session.get('godmode') %}
  const finishBtn = document.getElementById('finish-md-btn');
  const finishInput = document.getElementById('finish-md-input');
  const finishedStatus = document.getElementById('finished-status');
  
  const loadFinishedStatus = () => {
    fetch('{{ url_for("ucl.matchday_status") }}')
      .then(r => r.json())
      .then(data => {
        if (data.finished_matchdays && data.finished_matchdays.length > 0) {
          finishedStatus.innerHTML = `<span class="tag is-success">Завершенные туры: ${data.finished_matchdays.join(', ')}</span>`;
        } else {
          finishedStatus.innerHTML = '<span class="tag is-light">Нет завершенных туров</span>';
        }
      })
      .catch(err => console.error('Error loading status:', err));
  };
  
  finishBtn.addEventListener('click', () => {
    const md = finishInput.value;
    if (!md) return;
    
    const form = new FormData();
    form.append('md', md);
    
    fetch('{{ url_for("ucl.finish_matchday") }}', {
      method: 'POST',
      body: form
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        finishInput.value = '';
        loadFinishedStatus();
        // Reload results to reflect changes
        fetch(url).then(r => r.json()).then(render);
      } else {
        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
      }
    })
    .catch(err => {
      console.error('Error finishing matchday:', err);
      alert('Ошибка при завершении тура');
    });
  });
  
  loadFinishedStatus();
  {% endif %}

  const showPopup = p => {
    modalBody.innerHTML = '';
    modal.querySelector('.modal-card-title').textContent = 'Очки по MD';
    const md = [];
    const extra = [];
    (p.breakdown || []).forEach(it => {
      if (String(it.label).startsWith('MD')) md.push(it);
      else extra.push(it);
    });
    if (md.length) {
      const table = document.createElement('table');
      table.className = 'table is-narrow';
      const tbody = document.createElement('tbody');
      md.forEach(item => {
        const tr = document.createElement('tr');
        const tdL = document.createElement('td');
        tdL.textContent = item.label;
        const tdV = document.createElement('td');
        tdV.className = 'has-text-right';
        tdV.textContent = item.value;
        tr.appendChild(tdL);
        tr.appendChild(tdV);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      modalBody.appendChild(table);
    }
    if (extra.length) {
      if (md.length) {
        const hr = document.createElement('hr');
        modalBody.appendChild(hr);
      }
      const table = document.createElement('table');
      table.className = 'table is-narrow';
      const tbody = document.createElement('tbody');
      extra.forEach(item => {
        const tr = document.createElement('tr');
        const tdL = document.createElement('td');
        tdL.textContent = item.label;
        const tdV = document.createElement('td');
        tdV.className = 'has-text-right';
        tdV.textContent = item.value;
        tr.appendChild(tdL);
        tr.appendChild(tdV);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      modalBody.appendChild(table);
    }
    modal.classList.add('is-active');
  };

  const render = data => {
    const rawManagers = data.managers || [];
    const lineups = data.lineups || {};
    // Сортировка менеджеров от большего к меньшему по очкам (как на странице лайнапов)
    const managers = rawManagers.slice().sort((a, b) => {
      const totalA = Number(lineups[a] && lineups[a].total) || 0;
      const totalB = Number(lineups[b] && lineups[b].total) || 0;
      return totalB - totalA;
    });
    container.innerHTML = '';

    const tabs = document.createElement('div');
    tabs.className = 'tabs';
    const ul = document.createElement('ul');
    ul.style.flexGrow = '0';
    tabs.appendChild(ul);

    const contents = document.createElement('div');
    contents.style.display = 'block';

    managers.forEach((m, idx) => {
      const li = document.createElement('li');
      if (idx === 0) li.classList.add('is-active');
      const a = document.createElement('a');
      const nameStrong = document.createElement('strong');
      nameStrong.textContent = m;
      a.appendChild(nameStrong);
      const total = lineups[m] && lineups[m].total;
      if (total !== undefined && total !== null) {
        const span = document.createElement('span');
        span.style.backgroundColor = '#006400';
        span.style.color = 'white';
        span.style.padding = '0 4px';
        span.style.borderRadius = '3px';
        span.style.marginLeft = '4px';
        span.textContent = total;
        a.appendChild(span);
      }
      li.appendChild(a);
      ul.appendChild(li);

      const mgrDiv = document.createElement('div');
      mgrDiv.style.display = idx === 0 ? 'block' : 'none';
      const players = (lineups[m] && lineups[m].players) || [];
      const hue = idx * 60;
      const c1 = `hsl(${hue}, 70%, 90%)`;
      const c2 = `hsl(${hue}, 70%, 80%)`;
      players.sort((a, b) => {
        // First, sort by transfer status (transfer_out players go to the bottom)
        if (a.transfer_out && !b.transfer_out) return 1;
        if (!a.transfer_out && b.transfer_out) return -1;
        
        // Then sort by position
        const pa = (a.pos || '').toUpperCase();
        const pb = (b.pos || '').toUpperCase();
        return (posOrder[pa] ?? 99) - (posOrder[pb] ?? 99);
      });
      let lastPos = null;
      players.forEach((p, j) => {
        const pos = (p.pos || '').toUpperCase();
        if (pos !== lastPos) {
          if (j > 0) {
            const br = document.createElement('br');
            mgrDiv.appendChild(br);
          }
          lastPos = pos;
        }
        const div = document.createElement('div');
        div.className = 'player-row';
        div.style.background = (j % 2 === 0) ? c1 : c2;
        div.style.padding = '2px 4px';
        div.style.marginBottom = '1px';
        
        // Create player info container with images
        const infoWrap = document.createElement('span');
        infoWrap.className = 'player-info';
        
        // Add club logo
        const logo = document.createElement('img');
        logo.className = 'team-logo';
        if (p.teamId) {
          logo.src = `https://img.uefa.com/imgml/TP/teams/logos/140x140/${p.teamId}.png`;
        } else {
          logo.src = 'https://img.uefa.com/imgml/TP/teams/logos/140x140/0.png';
        }
        logo.alt = p.club || '';
        infoWrap.appendChild(logo);
        
        // Add player portrait
        const portrait = document.createElement('img');
        portrait.className = 'player-portrait';
        if (p.playerId) {
          portrait.src = `https://img.uefa.com/imgml/TP/players/1/2026/324x324/${p.playerId}.jpg`;
        } else {
          portrait.src = 'https://gaming.uefa.com/en/uclfantasy/static-assets/ucl2020/images/default_player@2x.png';
        }
        portrait.onerror = () => {
          portrait.src = 'https://gaming.uefa.com/en/uclfantasy/static-assets/ucl2020/images/default_player@2x.png';
        };
        portrait.alt = p.name;
        infoWrap.appendChild(portrait);
        
        // Add player name and position text
        const nameSpan = document.createElement('span');
        nameSpan.className = 'player-text';
        nameSpan.textContent = `${p.name} (${p.pos || '?'})`;
        if (p.club && !p.teamId) {
          nameSpan.textContent += ` - ${p.club}`;
        }
        infoWrap.appendChild(nameSpan);
        
        // Add matchdays indicator (как на странице лайнапов)
        if (Array.isArray(p.matchdays) && p.matchdays.length) {
          const spanMatchdays = document.createElement('span');
          spanMatchdays.className = 'player-matchdays';
          spanMatchdays.textContent = `Туры: ${p.matchdays.join(',')}`;
          infoWrap.appendChild(spanMatchdays);
        }
        
        // Add transfer status indicator and dimming for inactive players
        // Player is inactive if they are not in the current roster (is_active === false)
        const isInactive = p.is_active === false;
        
        if (isInactive) {
          const transferIcon = document.createElement('span');
          transferIcon.textContent = ' ⬇️';
          transferIcon.style.color = 'red';
          transferIcon.style.fontWeight = 'bold';
          transferIcon.title = 'Неактивный игрок';
          nameSpan.appendChild(transferIcon);
          div.style.opacity = '0.7';
        } else if (p.transfer_status === 'transfer_in') {
          const transferIcon = document.createElement('span');
          transferIcon.textContent = ' ⬆️';
          transferIcon.style.color = 'green';
          transferIcon.style.fontWeight = 'bold';
          transferIcon.title = 'Transfer in';
          nameSpan.appendChild(transferIcon);
        }
        
        div.appendChild(infoWrap);
        
        const pointsSpan = document.createElement('span');
        pointsSpan.className = 'points-box';
        pointsSpan.textContent = p.points || 0;
        if (p.breakdown && p.breakdown.length > 0) {
          pointsSpan.style.cursor = 'pointer';
          pointsSpan.addEventListener('click', () => showPopup(p));
        }
        div.appendChild(pointsSpan);
        
        mgrDiv.appendChild(div);
      });
      
      // Add available clubs section
      const availableClubs = lineups[m] && Array.isArray(lineups[m].available_clubs)
        ? lineups[m].available_clubs
        : [];
      if (availableClubs.length > 0) {
        const hr = document.createElement('hr');
        hr.className = 'my-2';
        mgrDiv.appendChild(hr);
        
        const clubsLabel = document.createElement('div');
        clubsLabel.style.fontWeight = 'bold';
        clubsLabel.style.marginBottom = '8px';
        clubsLabel.textContent = 'Доступные клубы:';
        mgrDiv.appendChild(clubsLabel);
        
        const clubsContainer = document.createElement('div');
        clubsContainer.style.display = 'flex';
        clubsContainer.style.flexWrap = 'wrap';
        clubsContainer.style.gap = '8px';
        clubsContainer.style.marginBottom = '16px';
        
        availableClubs.forEach(club => {
          const clubLogo = document.createElement('img');
          clubLogo.className = 'team-logo';
          clubLogo.style.width = '30px';
          clubLogo.style.height = '30px';
          if (club.teamId) {
            clubLogo.src = `https://img.uefa.com/imgml/TP/teams/logos/140x140/${club.teamId}.png`;
          } else {
            clubLogo.src = 'https://img.uefa.com/imgml/TP/teams/logos/140x140/0.png';
          }
          clubLogo.alt = club.clubName || '';
          clubLogo.title = club.clubName || '';
          clubsContainer.appendChild(clubLogo);
        });
        
        mgrDiv.appendChild(clubsContainer);
      }
      
      contents.appendChild(mgrDiv);

      // Tab click handler
      a.addEventListener('click', e => {
        e.preventDefault();
        // Hide all manager divs (only direct children of contents)
        Array.from(contents.children).forEach(div => div.style.display = 'none');
        // Show this manager's div
        mgrDiv.style.display = 'block';
        // Update active tab
        ul.querySelectorAll('li').forEach(li => li.classList.remove('is-active'));
        li.classList.add('is-active');
      });
    });

    container.appendChild(tabs);
    container.appendChild(contents);
  };

  fetch(url)
    .then(r => r.json())
    .then(render)
    .catch(err => {
      console.error('Error loading UCL results:', err);
      container.textContent = 'Ошибка загрузки данных';
    });
});
</script>
{% endblock %}
