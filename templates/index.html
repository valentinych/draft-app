{% extends "base.html" %}
{% block title %}{{ draft_title }}{% endblock %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/draft.css') }}"/>

<div class="page">
  <div class="topbar">
    <div class="topbar-left">
      <h1 class="page-title">{{ draft_title }}</h1>
      <div class="meta">
        {% if transfer_active %}
          <span class="badge badge-info">Идут трансферы</span>
          Сейчас ход: <strong>{{ transfer_user }}</strong>
          {% if current_user == transfer_user %}
          <form method="post" action="{{ url_for('epl.transfer_skip') }}" style="display:inline;">
            <button type="submit" class="btn btn-small">Пропустить трансфер</button>
          </form>
          {% endif %}
        {% elif draft_completed %}
          <span class="badge badge-muted">Драфт завершён</span>
        {% else %}
          {% if next_user %}
            Сейчас пик: <strong>{{ next_user }}</strong>{% if next_round %}, Раунд {{ next_round }}{% endif %}
          {% endif %}
        {% endif %}
      </div>
    </div>
    <div class="topbar-right">
      {% if status_url %}
        <a class="btn" href="{{ status_url }}">Состояние драфта</a>
      {% endif %}
      {% if session.get('godmode') %}
        <form method="post" action="{{ undo_url|default(url_for('epl.undo_last_pick')) }}">
          <button type="submit" class="btn btn-danger">Отменить последний пик</button>
        </form>
      {% endif %}
    </div>
  </div>

  <form method="get" id="filters-form" class="filters">
    {% if leagues is defined %}
    <div class="fld">
      <label for="league">Лига</label>
      <select name="league" id="league">
        <option value="">— Любая —</option>
        {% for l in leagues %}
          <option value="{{ l }}" {% if l == league_filter %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
    <div class="fld">
      <label for="club">Клуб</label>
      <select name="club" id="club">
        <option value="">— Любой —</option>
        {% for c in clubs %}
          <option value="{{ c }}" {% if c == club_filter %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="fld">
      <label for="position">Позиция</label>
      <select name="position" id="position">
        <option value="">— Любая —</option>
        {% for p in positions %}
          <option value="{{ p }}" {% if p == pos_filter %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="fld toggles">
      <label class="toggle">
        <input type="checkbox" id="wishlist-only-toggle" />
        <span>Show wishlist only</span>
        <span id="wishlist-count" class="badge">0</span>
      </label>
      <label class="toggle">
        <input type="checkbox" id="can-pick-toggle" />
        <span>Can Pick</span>
      </label>
      {% if table_league == 'epl' %}
      <label class="toggle">
        <input type="checkbox" id="hide-transfers-toggle" />
        <span>Спрятать трансферы</span>
      </label>
      <label class="toggle">
        <input type="checkbox" id="hide-reds-toggle" />
        <span>Спрятать красных</span>
      </label>
      {% endif %}
    </div>

    <div class="fld">
      <a class="btn-link" href="{{ request.path }}">Сбросить</a>
    </div>
  </form>

  {% set show_price = players and players[0].get('price') is not none %}
  {% set current_sort = request.args.get('sort') or 'price' %}
  {% set current_dir = request.args.get('dir', 'desc') %}
  {# Determine the endpoint name for sorting links.
     The top-4 draft uses the ``top4draft`` blueprint, so
     the naive concatenation above would result in ``top4.index``
     which does not exist and causes a BuildError. #}
  {% if table_league == 'top4' %}
    {% set route = 'top4draft.index' %}
  {% else %}
    {% set route = (table_league or 'epl') ~ '.index' %}
  {% endif %}
  {% set next_dir_price = 'asc' if current_sort == 'price' and current_dir == 'desc' else 'desc' %}
  {% set next_dir_pop = 'asc' if current_sort == 'popularity' and current_dir == 'desc' else 'desc' %}

  {% if players %}
    <div class="table-wrap">
      <table id="players" class="players-table"
             data-league="{{ table_league or 'epl' }}"
             data-manager="{{ current_user or 'guest' }}">
        <thead>
          <tr>
            <th class="col-wl" title="Wishlist">WL</th>
            <th class="num">ID</th>
            <th>Игрок</th>
            <th>Клуб</th>
            <th>Позиция</th>
            <th>Статус</th>
            {% if table_league == 'epl' %}<th>Статистика</th>{% endif %}
            {% if table_league == 'epl' %}
            <th class="num">
              <button type="button" id="fp-cur-sort-btn" class="link" data-dir="desc" title="Сортировать по FP 2025/26">
                FP 2025/26 <span id="fp-cur-sort-arrow">↓</span>
              </button>
            </th>
            {% endif %}
            <th class="num">
              <button type="button" id="fp-sort-btn" class="link" data-dir="desc" title="Сортировать по FP 2024/25">
                FP 2024/25 <span id="fp-sort-arrow">↓</span>
              </button>
            </th>
            {% if table_league == 'top4' %}
              <th class="num">
                <a href="{{ url_for(route, league=league_filter, club=club_filter, position=pos_filter, sort='popularity', dir=next_dir_pop) }}"
                   style="text-decoration:none;color:inherit">
                  Популярность
                  {% if current_sort == 'popularity' %}
                    {{ '↑' if current_dir == 'asc' else '↓' }}
                  {% endif %}
                </a>
              </th>
            {% endif %}
            {% if show_price %}
              <th class="num">
                <a href="{{ url_for(route, league=league_filter, club=club_filter, position=pos_filter, sort='price', dir=next_dir_price) }}"
                   style="text-decoration:none;color:inherit">
                  Цена
                  {% if current_sort == 'price' %}
                    {{ '↑' if current_dir == 'asc' else '↓' }}
                  {% endif %}
                </a>
              </th>
            {% endif %}
            <th class="num">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for p in players %}
            {% set disabled = draft_completed or (not p.canPick and not session.get('godmode')) %}
            <tr data-player-id="{{ p.playerId }}" data-can-pick="{{ '1' if p.canPick else '0' }}"
                data-status="{{ p.status or '' }}" data-chance="{{ p.chance or 0 }}"
                data-news="{{ (p.news or '')|lower|e }}">
              <td class="wishlist-cell">
                <input type="checkbox" class="wishlist-toggle" data-player-id="{{ p.playerId }}" />
              </td>
              <td class="num">{{ p.playerId }}</td>
              <td>{{ p.shortName or p.fullName }}</td>
              <td>{{ p.clubName }}</td>
              <td>{{ p.position }}</td>
              <td>
                {% if p.status and p.status != 'a' %}
                  {% set ch = p.chance or 0 %}
                  {% if ch >= 75 %}
                    <span class="status-circle status-yellow"></span>
                  {% elif ch >= 50 %}
                    <span class="status-circle status-orange"></span>
                  {% else %}
                    <span class="status-circle status-red"></span>
                  {% endif %}
                  {{ p.news }}
                {% endif %}
              </td>
              {% if table_league == 'epl' %}
              <td>
                <button type="button" class="link link-stat" data-pid="{{ p.playerId }}" data-name="{{ p.shortName or p.fullName }}">stat</button>
              </td>
              <td class="num">
                <span class="fp-cur-cell" data-fp="{{ (p.stats.points or 0)|int }}">{{ (p.stats.points or 0)|int }}</span>
              </td>
              {% endif %}
              <td class="num">
                <span class="fp-cell" data-pid="{{ p.playerId }}" data-fp="{{ p.fp_last or 0 }}">{{ (p.fp_last or 0)|int }}</span>
              </td>
              {% if table_league == 'top4' %}<td class="num">{{ '%.1f'|format(p.popularity) }}</td>{% endif %}
              {% if show_price %}<td class="num">{{ '%.1f'|format(p.price) }}</td>{% endif %}
              <td class="num">
                <form method="post" style="display:inline;">
                  <input type="hidden" name="player_id" value="{{ p.playerId }}" />
                  <button type="submit" {% if disabled %}disabled{% endif %}>Выбрать</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>Нет доступных игроков по текущим фильтрам.</p>
  {% endif %}
</div>

{% if table_league == 'epl' %}
<!-- Modal для статистики -->
<div id="stat-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" data-close="1"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="stat-title">
    <div class="modal-header">
      <div id="stat-title" class="modal-title">Статистика</div>
      <button type="button" class="modal-close" data-close="1" aria-label="Закрыть">×</button>
    </div>
    <div class="modal-body">
      <div id="stat-player" class="player-head">
        <img id="stat-photo" src="" alt="" class="player-photo" style="display:none;">
        <div class="player-meta">
          <div id="stat-name" class="player-name"></div>
        </div>
      </div>
      <div id="stat-loading" class="muted">Загрузка…</div>
      <div id="stat-empty" class="muted" style="display:none;">Нет данных</div>
      <div class="table-wrap" id="stat-table-wrap" style="display:none;">
        <table class="tbl">
          <thead>
            <tr>
              <th>Сезон</th>
              <th class="num">Мин</th>
              <th class="num">Голы</th>
              <th class="num">Пасы</th>
              <th class="num">CS</th>
              <th class="num">FP</th>
            </tr>
          </thead>
          <tbody id="stat-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if table_league == 'epl' %}
<script src="{{ url_for('static', filename='js/draft_epl.js') }}"></script>
{% else %}
<script src="{{ url_for('static', filename='js/draft_common.js') }}"></script>
{% endif %}
<script src="{{ url_for('static', filename='wishlist.js') }}"></script>
{% endblock %}
