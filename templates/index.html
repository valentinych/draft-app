{% extends "base.html" %}
{% block title %}{{ draft_title }}{% endblock %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/draft.css') }}"/>

<div class="page">
  <div class="topbar">
    <div class="topbar-left">
      <h1 class="page-title">{{ draft_title }}</h1>
      <div class="meta">
        {% if transfer_active %}
          <span class="badge badge-info">–ò–¥—É—Ç —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—ã</span>
          –°–µ–π—á–∞—Å —Ö–æ–¥: <strong>{{ transfer_user }}</strong>
          {% if current_user == transfer_user %}
          <form method="post" action="{{ url_for('epl.transfer_skip') }}" style="display:inline;">
            <button type="submit" class="btn btn-small">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä</button>
          </form>
          {% endif %}
        {% elif draft_completed %}
          <span class="badge badge-muted">–î—Ä–∞—Ñ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω</span>
        {% else %}
          {% if next_user %}
            –°–µ–π—á–∞—Å –ø–∏–∫: <strong>{{ next_user }}</strong>{% if next_round %}, –†–∞—É–Ω–¥ {{ next_round }}{% endif %}
          {% endif %}
        {% endif %}
      </div>
    </div>
    <div class="topbar-right">
      {% if status_url %}
        <a class="btn" href="{{ status_url }}">–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥—Ä–∞—Ñ—Ç–∞</a>
      {% endif %}
      {% if table_league == 'ucl' and not draft_completed and current_user and next_user and current_user == next_user %}
        <form method="post" style="display:inline; margin-left:8px;">
          <input type="hidden" name="action" value="skip" />
          <button type="submit" class="btn">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ–¥</button>
        </form>
      {% endif %}
      {% if session.get('godmode') %}
        {% if table_league == 'ucl' %}
        <form method="post" action="{{ url_for('ucl.cache_stats') }}" style="display:inline; margin-left:8px;">
          <button type="submit" class="btn"{% if stats_refresh_running %} disabled{% endif %}>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        </form>
        {% if stats_refresh_running %}
          <span class="badge badge-info" style="margin-left:8px;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è‚Ä¶</span>
        {% endif %}
        {% if draft_completed %}
        <form method="post" action="{{ url_for('ucl.populate_test_rosters') }}" style="display:inline; margin-left:8px;">
          <button type="submit" class="btn btn-warning">–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ—Å—Ç–∞–≤—ã</button>
        </form>
        <form method="post" action="{{ url_for('ucl.open_transfer_window') }}" style="display:inline; margin-left:8px;">
          <button type="submit" class="btn btn-info">–û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ</button>
        </form>
        <form method="post" action="{{ url_for('ucl.return_transfer_out_player') }}" style="display:inline; margin-left:8px;">
          <input type="hidden" name="player_id" value="250167832">
          <input type="hidden" name="manager" value="–°–µ—Ä–≥–µ–π">
          <button type="submit" class="btn btn-success">–í–µ—Ä–Ω—É—Ç—å Jobe Bellingham</button>
        </form>
        {% endif %}
        {% elif table_league == 'top4' %}
        {% if draft_completed %}
        <form method="post" action="{{ url_for('top4draft.open_transfer_window') }}" style="display:inline; margin-left:8px;">
          <button type="submit" class="btn btn-info">–û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ</button>
        </form>
        {% endif %}
        {% endif %}
        <form method="post" action="{{ undo_url|default(url_for('epl.undo_last_pick')) }}" style="display:inline; margin-left:8px;">
          <button type="submit" class="btn btn-danger">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–∏–∫</button>
        </form>
      {% endif %}
      
      <!-- MantraFootball Integration Controls - Always available for godmode users on TOP-4 -->
      {% if draft_title and 'Top-4' in draft_title and session.get('godmode') %}
      <div style="margin-top: 10px;">
        <button type="button" class="btn" onclick="syncMantraData('tournaments')" style="margin-left:8px;" id="sync-tournaments-btn">üèÜ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä—ã</button>
        <button type="button" class="btn" onclick="syncMantraData('players')" style="margin-left:8px;" id="sync-players-btn">üë• –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤</button>
        <button type="button" class="btn" onclick="syncMantraData('match-players')" style="margin-left:8px;" id="sync-matching-btn">üîó –°–≤—è–∑–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤</button>
        <button type="button" class="btn btn-primary" onclick="window.location.href='/top4/player-mapping'" style="margin-left:8px;">üéØ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π</button>
        <button type="button" class="btn" onclick="showSyncStatus()" style="margin-left:8px;">üìä –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</button>
        <button type="button" class="btn btn-info" onclick="toggleMantraMode()" style="margin-left:8px;" id="mantra-mode-btn">
          üîÑ {{ '–û—Ç–∫–ª—é—á–∏—Ç—å MantraFootball' if request.args.get('use_mantra') == 'true' else '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MantraFootball' }}
        </button>
      </div>
      {% endif %}
    </div>
  </div>

  <form method="get" id="filters-form" class="filters">
    {% if leagues is defined %}
    <div class="fld">
      <label for="league">–õ–∏–≥–∞</label>
      <select name="league" id="league">
        <option value="">‚Äî –õ—é–±–∞—è ‚Äî</option>
        {% for l in leagues %}
          <option value="{{ l }}" {% if l == league_filter %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
    <div class="fld">
      <label for="club">–ö–ª—É–±</label>
      <select name="club" id="club">
        <option value="">‚Äî –õ—é–±–æ–π ‚Äî</option>
        {% for c in clubs %}
          <option value="{{ c }}" {% if c == club_filter %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="fld">
      <label for="position">–ü–æ–∑–∏—Ü–∏—è</label>
      <select name="position" id="position">
        <option value="">‚Äî –õ—é–±–∞—è ‚Äî</option>
        {% for p in positions %}
          <option value="{{ p }}" {% if p == pos_filter %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="fld toggles">
      <label class="toggle">
        <input type="checkbox" id="wishlist-only-toggle" />
        <span>Show wishlist only</span>
        <span id="wishlist-count" class="badge">0</span>
      </label>
      <label class="toggle">
        <input type="checkbox" id="can-pick-toggle" />
        <span>Can Pick</span>
      </label>
      {% if table_league == 'epl' %}
      <label class="toggle">
        <input type="checkbox" id="hide-transfers-toggle" />
        <span>–°–ø—Ä—è—Ç–∞—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—ã</span>
      </label>
      <label class="toggle">
        <input type="checkbox" id="hide-reds-toggle" />
        <span>–°–ø—Ä—è—Ç–∞—Ç—å –∫—Ä–∞—Å–Ω—ã—Ö</span>
      </label>
      {% endif %}
    </div>

    <div class="fld">
      <a class="btn-link" href="{{ request.path }}">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </div>
  </form>

  {% if session.get('godmode') and managers %}
  <div class="card" style="margin:10px 0;">
    <div class="card-title">–ê–¥–º–∏–Ω: –±—ã—Å—Ç—Ä—ã–π –ø–∏–∫ –∑–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</div>
    <div class="card-body">
      {% if table_league == 'epl' %}
      <form method="post" action="{{ url_for('epl.admin_pick_player') }}" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label>–ú–µ–Ω–µ–¥–∂–µ—Ä
          <select name="manager">
            {% for m in managers %}
              <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
          </select>
        </label>
        <label>Player ID <input type="number" name="player_id" placeholder="e.g. 674" required></label>
        <label><input type="checkbox" name="advance" value="1"> –°–¥–≤–∏–Ω—É—Ç—å –æ—á–µ—Ä–µ–¥—å</label>
        <button type="submit" class="btn">–ü–∏–∫–Ω—É—Ç—å</button>
      </form>
      {% elif table_league == 'ucl' %}
      <form method="post" action="{{ url_for('ucl.index') }}" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input type="hidden" name="action" value="pick" />
        <label>–ú–µ–Ω–µ–¥–∂–µ—Ä
          <select name="as_user">
            {% for m in managers %}
              <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
          </select>
        </label>
        <label>Player ID <input type="number" name="player_id" placeholder="UCL id" required></label>
        <button type="submit" class="btn">–ü–∏–∫–Ω—É—Ç—å</button>
      </form>
      {% endif %}
    </div>
  </div>
  {% endif %}


  {# Transfer interface for TOP4 when window is active #}
  {% if table_league == 'top4' and transfer_window_active and current_user == current_transfer_manager %}
    {% if current_transfer_phase == 'out' %}
    <div class="card" style="margin:10px 0; border: 2px solid #ff6b35;">
      <div class="card-title" style="background: #ff6b35; color: white;">
        ‚öΩ –í–∞—à —Ö–æ–¥ - TRANSFER OUT: –≤—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –æ—Ç–¥–∞—á–∏
      </div>
      <div class="card-body">
        <p style="margin: 0; font-size: 16px;">
          <strong>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –∏–∑ –≤–∞—à–µ–≥–æ —Å–æ—Å—Ç–∞–≤–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–∏–∂–µ</strong> –¥–ª—è transfer out.
          <br><small style="color: #666;">–í —Ç–∞–±–ª–∏—Ü–µ –ø–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –≤–∞—à–∏ –∏–≥—Ä–æ–∫–∏. –ü–æ—Å–ª–µ –∫–ª–∏–∫–∞ –∏–≥—Ä–æ–∫ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ transfer out –ø—É–ª.</small>
        </p>
        <p style="margin-top: 10px; padding: 8px; background: #fff3cd; border-left: 4px solid #ffc107; font-size: 14px;">
          <strong>üìã –≠—Ç–∞–ø 1 –∏–∑ 2:</strong> –°–Ω–∞—á–∞–ª–∞ –æ—Ç–¥–∞–π—Ç–µ –∏–≥—Ä–æ–∫–∞, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ–Ω—É
        </p>
      </div>
    </div>
    {% elif current_transfer_phase == 'in' %}
    <div class="card" style="margin:10px 0; border: 2px solid #28a745;">
      <div class="card-title" style="background: #28a745; color: white;">
        üéØ –í–∞—à —Ö–æ–¥ - TRANSFER IN: –≤—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è
      </div>
      <div class="card-body">
        <p style="margin: 0; font-size: 16px;">
          <strong>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –Ω–∏–∂–µ</strong> –¥–ª—è transfer in.
          <br><small style="color: #666;">–í —Ç–∞–±–ª–∏—Ü–µ –ø–æ–∫–∞–∑–∞–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–≥—Ä–æ–∫–∏. –ü–æ—Å–ª–µ –∫–ª–∏–∫–∞ –∏–≥—Ä–æ–∫ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à—É –∫–æ–º–∞–Ω–¥—É.</small>
        </p>
        <p style="margin-top: 10px; padding: 8px; background: #d4edda; border-left: 4px solid #28a745; font-size: 14px;">
          <strong>‚úÖ –≠—Ç–∞–ø 2 –∏–∑ 2:</strong> –ò–≥—Ä–æ–∫ –æ—Ç–¥–∞–Ω, —Ç–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ–Ω—É. –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ö–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É.
        </p>
      </div>
    </div>
    {% endif %}
  {% elif table_league == 'top4' and transfer_window_active and current_transfer_manager %}
  <div class="card" style="margin:10px 0; border: 2px solid #74b9ff;">
    <div class="card-title" style="background: #74b9ff; color: white;">
      üïí –¢—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
    </div>
    <div class="card-body">
      <p><strong>–°–µ–π—á–∞—Å —Ö–æ–¥:</strong> {{ current_transfer_manager }}</p>
      <p>–û–∂–∏–¥–∞–π—Ç–µ —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞.</p>
      <p><small><a href="{{ url_for('transfers.transfer_history', draft_type='top4') }}">–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤ ‚Üí</a></small></p>
    </div>
  </div>
  {% endif %}

  {# Transfer interface for UCL when window is active #}
  {% if table_league == 'ucl' and transfer_window_active and current_user == current_transfer_manager %}
    {% if current_transfer_phase == 'out' %}
    <div class="card" style="margin:10px 0; border: 2px solid #ff6b35;">
      <div class="card-title" style="background: #ff6b35; color: white;">
        ‚öΩ –í–∞—à —Ö–æ–¥ - TRANSFER OUT: –≤—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –æ—Ç–¥–∞—á–∏
      </div>
      <div class="card-body">
        <p style="margin: 0; font-size: 16px;">
          <strong>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –∏–∑ –≤–∞—à–µ–≥–æ —Å–æ—Å—Ç–∞–≤–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–∏–∂–µ</strong> –¥–ª—è transfer out.
          <br><small style="color: #666;">–í —Ç–∞–±–ª–∏—Ü–µ –ø–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –≤–∞—à–∏ –∏–≥—Ä–æ–∫–∏. –ü–æ—Å–ª–µ –∫–ª–∏–∫–∞ –∏–≥—Ä–æ–∫ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ transfer out –ø—É–ª.</small>
        </p>
        <p style="margin-top: 10px; padding: 8px; background: #fff3cd; border-left: 4px solid #ffc107; font-size: 14px;">
          <strong>üìã –≠—Ç–∞–ø 1 –∏–∑ 2:</strong> –°–Ω–∞—á–∞–ª–∞ –æ—Ç–¥–∞–π—Ç–µ –∏–≥—Ä–æ–∫–∞, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ–Ω—É
        </p>
      </div>
    </div>
    {% elif current_transfer_phase == 'in' %}
    <div class="card" style="margin:10px 0; border: 2px solid #28a745;">
      <div class="card-title" style="background: #28a745; color: white;">
        üéØ –í–∞—à —Ö–æ–¥ - TRANSFER IN: –≤—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è
      </div>
      <div class="card-body">
        <p style="margin: 0; font-size: 16px;">
          <strong>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –Ω–∏–∂–µ</strong> –¥–ª—è transfer in.
          <br><small style="color: #666;">–í —Ç–∞–±–ª–∏—Ü–µ –ø–æ–∫–∞–∑–∞–Ω—ã –∏–≥—Ä–æ–∫–∏ –∏–∑ transfer out –ø—É–ª–∞. –ü–æ—Å–ª–µ –∫–ª–∏–∫–∞ –∏–≥—Ä–æ–∫ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à—É –∫–æ–º–∞–Ω–¥—É.</small>
        </p>
        <p style="margin-top: 10px; padding: 8px; background: #d4edda; border-left: 4px solid #28a745; font-size: 14px;">
          <strong>‚úÖ –≠—Ç–∞–ø 2 –∏–∑ 2:</strong> –ò–≥—Ä–æ–∫ –æ—Ç–¥–∞–Ω, —Ç–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ–Ω—É. –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ö–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É.
        </p>
      </div>
    </div>
    {% endif %}
  {% elif table_league == 'ucl' and transfer_window_active and current_transfer_manager %}
  <div class="card" style="margin:10px 0; border: 2px solid #74b9ff;">
    <div class="card-title" style="background: #74b9ff; color: white;">
      üïí –¢—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
    </div>
    <div class="card-body">
      <p><strong>–°–µ–π—á–∞—Å —Ö–æ–¥:</strong> {{ current_transfer_manager }}</p>
      <p>–û–∂–∏–¥–∞–π—Ç–µ —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞.</p>
      <p><small><a href="{{ url_for('transfers.transfer_history', draft_type='ucl') }}">–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤ ‚Üí</a></small></p>
    </div>
  </div>
  {% endif %}

  {% set show_price = players and players[0].get('price') is not none %}
  {% set current_sort = request.args.get('sort') or 'price' %}
  {% set current_dir = request.args.get('dir', 'desc') %}
  {# Determine the endpoint name for sorting links.
     The top-4 draft uses the ``top4draft`` blueprint, so
     the naive concatenation above would result in ``top4.index``
     which does not exist and causes a BuildError. #}
  {% if table_league == 'top4' %}
    {% set route = 'top4draft.index' %}
  {% else %}
    {% set route = (table_league or 'epl') ~ '.index' %}
  {% endif %}
  {% set next_dir_price = 'asc' if current_sort == 'price' and current_dir == 'desc' else 'desc' %}
  {% set next_dir_pop = 'asc' if current_sort == 'popularity' and current_dir == 'desc' else 'desc' %}
  {% set next_dir_pts = 'asc' if current_sort == 'pts' and current_dir == 'desc' else 'desc' %}

  {% if players %}
    <div class="table-wrap">
      <table id="players" class="players-table"
             data-league="{{ table_league or 'epl' }}"
             data-manager="{{ current_user or 'guest' }}">
        <thead>
          <tr>
            <th class="col-wl" title="Wishlist">WL</th>
            <th class="num">ID</th>
            <th>–ò–≥—Ä–æ–∫</th>
            <th>–ö–ª—É–±</th>
            <th>–ü–æ–∑–∏—Ü–∏—è</th>
            {% if table_league == 'top4' %}
            <th class="num">
              <a href="{{ url_for(route, league=league_filter, club=club_filter, position=pos_filter, sort='pts', dir=next_dir_pts) }}"
                 style="text-decoration:none;color:inherit">
                PTS
                {% if current_sort == 'pts' %}
                  {{ '‚Üë' if current_dir == 'asc' else '‚Üì' }}
                {% endif %}
              </a>
            </th>
            {% else %}
            <th>–°—Ç–∞—Ç—É—Å</th>
            {% endif %}
            {% if table_league == 'epl' %}<th>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th>{% endif %}
            {% if table_league == 'epl' %}
            <th class="num">
              <button type="button" id="fp-cur-sort-btn" class="link" data-dir="desc" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ FP 2025/26">
                FP 2025/26 <span id="fp-cur-sort-arrow">‚Üì</span>
              </button>
            </th>
            {% elif table_league == 'ucl' %}
            <th class="num">
              <button type="button" id="fp-cur-sort-btn" class="link" data-dir="desc" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ FP 2025/26">
                FP 2025/26 <span id="fp-cur-sort-arrow">‚Üì</span>
              </button>
            </th>
            {% endif %}
            {% if table_league == 'top4' %}
              <th class="num">
                <a href="{{ url_for(route, league=league_filter, club=club_filter, position=pos_filter, sort='popularity', dir=next_dir_pop) }}"
                   style="text-decoration:none;color:inherit">
                  –ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å
                  {% if current_sort == 'popularity' %}
                    {{ '‚Üë' if current_dir == 'asc' else '‚Üì' }}
                  {% endif %}
                </a>
              </th>
            {% endif %}
            {% if show_price %}
              <th class="num">
                <a href="{{ url_for(route, league=league_filter, club=club_filter, position=pos_filter, sort='price', dir=next_dir_price) }}"
                   style="text-decoration:none;color:inherit">
                  –¶–µ–Ω–∞
                  {% if current_sort == 'price' %}
                    {{ '‚Üë' if current_dir == 'asc' else '‚Üì' }}
                  {% endif %}
                </a>
              </th>
            {% endif %}
            <th class="num">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for p in players %}
            {% set disabled = (draft_completed or (not p.canPick and not session.get('godmode'))) and not (table_league == 'top4' and transfer_window_active and is_current_manager) %}
            <tr data-player-id="{{ p.playerId }}" data-can-pick="{{ '1' if p.canPick else '0' }}"
                data-status="{{ p.status or '' }}" data-chance="{{ p.chance or 0 }}"
                data-news="{{ (p.news or '')|lower|e }}">
              <td class="wishlist-cell">
                <input type="checkbox" class="wishlist-toggle" data-player-id="{{ p.playerId }}" />
              </td>
              <td class="num">{{ p.playerId }}</td>
              <td>{{ p.shortName or p.fullName }}</td>
              <td>{{ p.clubName }}</td>
              <td>{{ p.position }}</td>
              {% if table_league == 'top4' %}
              <td class="num">{{ '%.1f'|format(p.fp_last or 0) }}</td>
              {% else %}
              <td>
                {% if p.status and p.status != 'a' %}
                  {% set ch = p.chance or 0 %}
                  {% if ch >= 75 %}
                    <span class="status-circle status-yellow"></span>
                  {% elif ch >= 50 %}
                    <span class="status-circle status-orange"></span>
                  {% else %}
                    <span class="status-circle status-red"></span>
                  {% endif %}
                  {{ p.news }}
                {% endif %}
              </td>
              {% endif %}
              {% if table_league == 'epl' %}
              <td>
                <button type="button" class="link link-stat" data-pid="{{ p.playerId }}" data-name="{{ p.shortName or p.fullName }}">stat</button>
              </td>
              <td class="num">
                <span class="fp-cur-cell" data-fp="{{ (p.stats.points or 0)|int }}">{{ (p.stats.points or 0)|int }}</span>
              </td>
              {% elif table_league == 'ucl' %}
              <td class="num">
                <span class="fp-cur-cell" data-fp="{{ (p.fp_current or 0)|int }}">{{ (p.fp_current or 0)|int }}</span>
              </td>
              {% endif %}
              {% if table_league == 'top4' %}<td class="num">{{ '%.1f'|format(p.popularity) }}</td>{% endif %}
              {% if show_price %}<td class="num">{{ '%.1f'|format(p.price) }}</td>{% endif %}
              <td class="num">
                <form method="post" style="display:inline;">
                  <input type="hidden" name="player_id" value="{{ p.playerId }}" />
                  <button type="submit" {% if disabled %}disabled{% endif %}>–í—ã–±—Ä–∞—Ç—å</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –ø–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</p>
  {% endif %}
</div>

{% if table_league == 'epl' %}
<!-- Modal –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div id="stat-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" data-close="1"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="stat-title">
    <div class="modal-header">
      <div id="stat-title" class="modal-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <button type="button" class="modal-close" data-close="1" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    </div>
    <div class="modal-body">
      <div id="stat-player" class="player-head">
        <img id="stat-photo" src="" alt="" class="player-photo" style="display:none;">
        <div class="player-meta">
          <div id="stat-name" class="player-name"></div>
        </div>
      </div>
      <div id="stat-loading" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      <div id="stat-empty" class="muted" style="display:none;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
      <div class="table-wrap" id="stat-table-wrap" style="display:none;">
        <table class="tbl">
          <thead>
            <tr>
              <th>–°–µ–∑–æ–Ω</th>
              <th class="num">–ú–∏–Ω</th>
              <th class="num">–ì–æ–ª—ã</th>
              <th class="num">–ü–∞—Å—ã</th>
              <th class="num">CS</th>
              <th class="num">FP</th>
            </tr>
          </thead>
          <tbody id="stat-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if table_league == 'epl' %}
<script src="{{ url_for('static', filename='js/draft_epl.js') }}"></script>
{% else %}
<script src="{{ url_for('static', filename='js/draft_common.js') }}"></script>
{% endif %}
<script src="{{ url_for('static', filename='wishlist.js') }}"></script>

{# Transfer functionality for UCL #}
{% if table_league == 'ucl' and transfer_window_active %}
<script>
// Transfer functions for UCL main page
function selectPlayerForTransferOut(playerId, playerName, playerClub, playerPosition) {
  if (confirm(`–û—Ç–¥–∞—Ç—å –∏–≥—Ä–æ–∫–∞ ${playerName} (${playerClub}, ${playerPosition}) –≤ transfer out –ø—É–ª?`)) {
    // Show loading state
    const buttons = document.querySelectorAll('button[onclick*="selectPlayerForTransferOut"]');
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = '0.6';
    });
    
    // Send transfer out request
    fetch('/transfers/ucl/pick-transfer-player', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `player_id=${playerId}`
    })
    .then(response => {
      // Check if response is ok
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      // Try to parse as JSON, if fails then it's probably a redirect/HTML
      return response.text().then(text => {
        try {
          return JSON.parse(text);
        } catch (e) {
          // If not JSON, assume success and reload page
          console.log('Non-JSON response, reloading page');
          window.location.reload();
          return null;
        }
      });
    })
    .then(data => {
      if (data === null) {
        // Page will reload, no need to do anything
        return;
      }
      if (data.success) {
        // Show success message and reload page
        alert('‚úÖ ' + (data.message || '–ò–≥—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ transfer out –ø—É–ª!'));
        window.location.reload();
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        // Re-enable buttons
        buttons.forEach(btn => {
          btn.disabled = false;
          btn.style.opacity = '1';
        });
      }
    })
    .catch(error => {
      console.error('Transfer out error:', error);
      alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–≥—Ä–æ–∫–∞: ' + error.message);
      // Re-enable buttons
      buttons.forEach(btn => {
        btn.disabled = false;
        btn.style.opacity = '1';
      });
    });
  }
}

function showAvailableTransferPlayers(outPlayerId) {
  // Fetch available players for transfer in
  fetch('/transfers/ucl/available-players')
    .then(response => response.json())
    .then(data => {
      if (data.success && data.players && data.players.length > 0) {
        displayAvailablePlayers(data.players, outPlayerId);
      } else {
        alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞');
        window.location.reload(); // Reload to show updated state
      }
    })
    .catch(error => {
      console.error('Available players error:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤: ' + error.message);
      window.location.reload();
    });
}

function displayAvailablePlayers(players, outPlayerId) {
  // Create modal for player selection
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
    align-items: center; justify-content: center; padding: 20px;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: white; padding: 20px; border-radius: 8px; 
    max-width: 800px; max-height: 80vh; overflow-y: auto; width: 100%;
  `;
  
  modalContent.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0;">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è transfer in</h3>
      <button onclick="closeTransferReplacementModal()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">‚úï</button>
    </div>
    <div id="available-players-list"></div>
  `;
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  modal.id = 'transfer-replacement-modal';
  
  // Group players by position
  const positions = ['GK', 'DEF', 'MID', 'FWD'];
  const playersByPosition = {};
  players.forEach(player => {
    const pos = player.position || 'OTHER';
    if (!playersByPosition[pos]) playersByPosition[pos] = [];
    playersByPosition[pos].push(player);
  });
  
  const listContainer = document.getElementById('available-players-list');
  positions.forEach(pos => {
    if (playersByPosition[pos] && playersByPosition[pos].length > 0) {
      const posSection = document.createElement('div');
      posSection.style.marginBottom = '20px';
      
      const posTitle = document.createElement('h4');
      posTitle.textContent = pos;
      posTitle.style.cssText = 'margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;';
      posSection.appendChild(posTitle);
      
      const playersGrid = document.createElement('div');
      playersGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;';
      
      playersByPosition[pos].forEach(player => {
        const playerBtn = document.createElement('button');
        playerBtn.style.cssText = `
          background: #e8f5e8; border: 1px solid #28a745; padding: 10px; 
          border-radius: 5px; text-align: left; cursor: pointer; transition: background 0.2s;
        `;
        playerBtn.innerHTML = `
          <strong>${player.fullName || player.name}</strong><br>
          <small style="color: #666;">${player.clubName || player.club}</small>
        `;
        playerBtn.onmouseover = () => playerBtn.style.background = '#d4edda';
        playerBtn.onmouseout = () => playerBtn.style.background = '#e8f5e8';
        playerBtn.onclick = () => selectReplacementPlayer(outPlayerId, player.playerId || player.id, player.fullName || player.name, player.clubName || player.club, player.position);
        
        playersGrid.appendChild(playerBtn);
      });
      
      posSection.appendChild(playersGrid);
      listContainer.appendChild(posSection);
    }
  });
  
  // Close modal on background click
  modal.onclick = (e) => {
    if (e.target === modal) closeTransferReplacementModal();
  };
}

function selectReplacementPlayer(outPlayerId, inPlayerId, inPlayerName, inPlayerClub, inPlayerPosition) {
  if (confirm(`–í–∑—è—Ç—å –∏–≥—Ä–æ–∫–∞ ${inPlayerName} (${inPlayerClub}, ${inPlayerPosition}) –≤ –∫–æ–º–∞–Ω–¥—É?`)) {
    // Execute the transfer
    fetch('/transfers/ucl/execute', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `out_player_id=${outPlayerId}&in_player_id=${inPlayerId}`
    })
    .then(response => {
      if (response.redirected) {
        window.location.href = response.url;
        return;
      }
      return response.json();
    })
    .then(data => {
      if (data && !data.success) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      } else {
        // Success - reload page to show updated state
        window.location.reload();
      }
    })
    .catch(error => {
      console.error('Execute transfer error:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞: ' + error.message);
    });
  }
}

function closeTransferReplacementModal() {
  const modal = document.getElementById('transfer-replacement-modal');
  if (modal) {
    modal.remove();
  }
  // Re-enable transfer out buttons
  const buttons = document.querySelectorAll('button[onclick*="selectPlayerForTransferOut"]');
  buttons.forEach(btn => {
    btn.disabled = false;
    btn.style.opacity = '1';
  });
}

// Add click handlers to table rows for transfer out
document.addEventListener('DOMContentLoaded', function() {
  const table = document.getElementById('players');
  if (table) {
    // Add click handlers to player rows
    table.addEventListener('click', function(e) {
      const row = e.target.closest('tr[data-player-id]');
      if (row && row.dataset.canPick === '1') {
        const playerId = row.dataset.playerId;
        const playerName = row.cells[2]?.textContent || 'Unknown';
        const playerClub = row.cells[3]?.textContent || 'Unknown';
        const playerPosition = row.cells[4]?.textContent || 'Unknown';
        
        // Call transfer out function
        selectPlayerForTransferOut(playerId, playerName, playerClub, playerPosition);
      }
    });
    
    // Style clickable rows
    const clickableRows = table.querySelectorAll('tr[data-can-pick="1"]');
    clickableRows.forEach(row => {
      row.style.cursor = 'pointer';
      row.style.transition = 'background-color 0.2s';
      row.addEventListener('mouseenter', () => {
        row.style.backgroundColor = '#fff3cd';
      });
      row.addEventListener('mouseleave', () => {
        row.style.backgroundColor = '';
      });
    });
  }
});

// Note: MantraFootball functions moved to global scope at end of template
</script>
{% endif %}

{# MantraFootball JavaScript functions - available on all pages #}
<script>
// MantraFootball Integration Functions
function syncMantraData(type) {
  const btn = document.getElementById(`sync-${type.replace('-', '')}-btn`);
  if (btn) {
    btn.disabled = true;
    btn.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
  }
  
  fetch(`/mantra/sync/${type}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({include_stats: type === 'players'})
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert('–û—à–∏–±–∫–∞: ' + data.error);
    } else {
      alert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞: ' + data.message);
      // Start polling for status
      pollSyncStatus();
    }
  })
  .catch(error => {
    alert('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + error);
  })
  .finally(() => {
    if (btn) {
      btn.disabled = false;
      btn.textContent = btn.textContent.replace('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...', btn.id.includes('tournaments') ? 'üèÜ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä—ã' : 
                                                                     btn.id.includes('players') ? 'üë• –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤' : 'üîó –°–≤—è–∑–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤');
    }
  });
}

function showSyncStatus() {
  fetch('/mantra/sync/status')
  .then(response => response.json())
  .then(data => {
    let statusText = '–°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:\n\n';
    
    // Sync status
    const syncStatus = data.sync_status;
    statusText += '–¢—É—Ä–Ω–∏—Ä—ã: ' + (syncStatus.tournaments.running ? '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è... ' + syncStatus.tournaments.message : '–ì–æ—Ç–æ–≤ - ' + syncStatus.tournaments.message) + '\n';
    statusText += '–ò–≥—Ä–æ–∫–∏: ' + (syncStatus.players.running ? '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è... ' + syncStatus.players.message : '–ì–æ—Ç–æ–≤ - ' + syncStatus.players.message) + '\n';
    statusText += '–°–≤—è–∑—ã–≤–∞–Ω–∏–µ: ' + (syncStatus.matching.running ? '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è... ' + syncStatus.matching.message : '–ì–æ—Ç–æ–≤ - ' + syncStatus.matching.message) + '\n\n';
    
    // Cache status
    const cacheStatus = data.get_cache_status || data.cache_status;
    if (cacheStatus) {
      statusText += '–ö—ç—à:\n';
      for (const [key, status] of Object.entries(cacheStatus)) {
        statusText += `${key}: ${status.exists ? '–ï—Å—Ç—å (' + (status.last_updated || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') + ')' : '–ù–µ—Ç'}\n`;
      }
    }
    
    alert(statusText);
  })
  .catch(error => {
    alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + error);
  });
}

function pollSyncStatus() {
  setTimeout(() => {
    fetch('/mantra/sync/status')
    .then(response => response.json())
    .then(data => {
      const syncStatus = data.sync_status;
      const anyRunning = syncStatus.tournaments.running || syncStatus.players.running || syncStatus.matching.running;
      
      if (anyRunning) {
        // Continue polling
        pollSyncStatus();
      } else {
        // All done, refresh buttons
        location.reload();
      }
    })
    .catch(() => {
      // Stop polling on error
    });
  }, 2000);
}

function toggleMantraMode() {
  const currentUrl = new URL(window.location);
  const useMantra = currentUrl.searchParams.get('use_mantra') === 'true';
  
  if (useMantra) {
    currentUrl.searchParams.delete('use_mantra');
  } else {
    currentUrl.searchParams.set('use_mantra', 'true');
  }
  
  window.location.href = currentUrl.toString();
}
</script>

{# Transfer functionality for TOP4 #}
{% if table_league == 'top4' and transfer_window_active %}
<script>
// Transfer functions for TOP4 main page
function selectPlayerForTransferOut(playerId, playerName, playerClub, playerPosition) {
  if (confirm(`–û—Ç–¥–∞—Ç—å –∏–≥—Ä–æ–∫–∞ ${playerName} (${playerClub}, ${playerPosition}) –≤ transfer out –ø—É–ª?`)) {
    // Show loading state
    const buttons = document.querySelectorAll('button[onclick*="selectPlayerForTransferOut"]');
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = '0.6';
    });
    
    // Send transfer out request
    fetch('/transfers/top4/pick-transfer-player', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `player_id=${playerId}`
    })
    .then(response => {
      // Check if response is ok
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      // Try to parse as JSON, if fails then it's probably a redirect/HTML
      return response.text().then(text => {
        try {
          return JSON.parse(text);
        } catch (e) {
          // If not JSON, assume success and reload page
          console.log('Non-JSON response, reloading page');
          window.location.reload();
          return null;
        }
      });
    })
    .then(data => {
      if (data === null) {
        // Page will reload, no need to do anything
        return;
      }
      
      if (data.success) {
        console.log('Transfer out successful:', data.message);
        // Reload the page to show updated state
        window.location.reload();
      } else {
        alert('–û—à–∏–±–∫–∞: ' + data.error);
        // Re-enable buttons
        buttons.forEach(btn => {
          btn.disabled = false;
          btn.style.opacity = '1';
        });
      }
    })
    .catch(error => {
      console.error('Transfer out error:', error);
      alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞');
      // Re-enable buttons
      buttons.forEach(btn => {
        btn.disabled = false;
        btn.style.opacity = '1';
      });
    });
  }
}

function selectPlayerForTransferIn(playerId, playerName, playerClub, playerPosition) {
  if (confirm(`–ü–æ–ª—É—á–∏—Ç—å –∏–≥—Ä–æ–∫–∞ ${playerName} (${playerClub}, ${playerPosition}) –≤ —Å–≤–æ—é –∫–æ–º–∞–Ω–¥—É?`)) {
    // Show loading state
    const buttons = document.querySelectorAll('button[onclick*="selectPlayerForTransferIn"]');
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = '0.6';
    });
    
    // Send transfer in request
    fetch('/transfers/top4/transfer-player-in', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `player_id=${playerId}`
    })
    .then(response => {
      // Check if response is ok
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      // Try to parse as JSON, if fails then it's probably a redirect/HTML
      return response.text().then(text => {
        try {
          return JSON.parse(text);
        } catch (e) {
          // If not JSON, assume success and reload page
          console.log('Non-JSON response, reloading page');
          window.location.reload();
          return null;
        }
      });
    })
    .then(data => {
      if (data === null) {
        // Page will reload, no need to do anything
        return;
      }
      
      if (data.success) {
        console.log('Transfer in successful:', data.message);
        // Reload the page to show updated state
        window.location.reload();
      } else {
        alert('–û—à–∏–±–∫–∞: ' + data.error);
        // Re-enable buttons
        buttons.forEach(btn => {
          btn.disabled = false;
          btn.style.opacity = '1';
        });
      }
    })
    .catch(error => {
      console.error('Transfer in error:', error);
      alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞');
      // Re-enable buttons
      buttons.forEach(btn => {
        btn.disabled = false;
        btn.style.opacity = '1';
      });
    });
  }
}

// Override button clicks for transfer functionality
document.addEventListener('DOMContentLoaded', function() {
  const playerTable = document.getElementById('players');
  if (!playerTable) return;
  
  const isTransferOut = {{ 'true' if current_transfer_phase == 'out' else 'false' }};
  const isTransferIn = {{ 'true' if current_transfer_phase == 'in' else 'false' }};
  const isCurrentManager = {{ 'true' if is_current_manager else 'false' }};
  
  if (!isCurrentManager) return;
  
  // Override form submissions for transfer functionality
  const forms = playerTable.querySelectorAll('form');
  forms.forEach(form => {
    const button = form.querySelector('button[type="submit"]');
    const playerIdInput = form.querySelector('input[name="player_id"]');
    
    if (!button || !playerIdInput) return;
    
    const playerId = playerIdInput.value;
    const row = form.closest('tr');
    const playerName = row?.cells[2]?.textContent?.trim() || 'Unknown';
    const playerClub = row?.cells[3]?.textContent?.trim() || 'Unknown';
    const playerPosition = row?.cells[4]?.textContent?.trim() || 'Unknown';
    
    // Replace the button click handler
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (isTransferOut) {
        selectPlayerForTransferOut(playerId, playerName, playerClub, playerPosition);
      } else if (isTransferIn) {
        selectPlayerForTransferIn(playerId, playerName, playerClub, playerPosition);
      }
    });
  });
});
</script>
{% endif %}

{% endblock %}
