{% extends "base.html" %}
{% block title %}{{ draft_title }}{% endblock %}
{% block content %}

<div class="page">
  <!-- Верхняя панель -->
  <div class="topbar">
    <div class="topbar-left">
      <h1 class="page-title">{{ draft_title }}</h1>
      <div class="meta">
        {% if draft_completed %}
          <span class="badge badge-muted">Драфт завершён</span>
        {% else %}
          {% if next_user %}
            Сейчас пик: <strong>{{ next_user }}</strong>{% if next_round %}, Раунд {{ next_round }}{% endif %}
          {% endif %}
        {% endif %}
      </div>
    </div>
    <div class="topbar-right">
      {% if status_url %}
        <a class="btn" href="{{ status_url }}">Состояние драфта</a>
      {% endif %}
      {% if session.get('godmode') %}
        <form method="post" action="{{ url_for('epl.undo_last_pick') }}">
          <button type="submit" class="btn btn-danger">Отменить последний пик</button>
        </form>
      {% endif %}
    </div>
  </div>

  <!-- Фильтры (всегда под тулбаром, на всю ширину) -->
  <form method="get" id="filters-form" class="filters">
    <div class="fld">
      <label for="club">Клуб</label>
      <select name="club" id="club">
        <option value="">— Любой —</option>
        {% for c in clubs %}
          <option value="{{ c }}" {% if c == club_filter %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="fld">
      <label for="position">Позиция</label>
      <select name="position" id="position">
        <option value="">— Любая —</option>
        {% for p in positions %}
          <option value="{{ p }}" {% if p == pos_filter %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="fld toggles">
      <label class="toggle">
        <input type="checkbox" id="wishlist-only-toggle" />
        <span>Show wishlist only</span>
        <span id="wishlist-count" class="badge">0</span>
      </label>
      <label class="toggle">
        <input type="checkbox" id="can-pick-toggle" />
        <span>Can Pick</span>
      </label>
    </div>

    <div class="fld">
      <a class="btn-link" href="{{ request.path }}">Сбросить</a>
    </div>
  </form>

  {% set show_price = players and players[0].get('price') is not none %}
  {% set current_sort = request.args.get('sort') or 'price' %}
  {% set current_dir = request.args.get('dir', 'desc') %}
  {% set next_dir = 'asc' if current_sort == 'price' and current_dir == 'desc' else 'desc' %}

  {% if players %}
    <div class="table-wrap">
      <table id="players" class="players-table"
             data-league="epl"
             data-manager="{{ current_user or 'guest' }}">
        <thead>
          <tr>
            <th class="col-wl" title="Wishlist">WL</th>
            <th class="num">ID</th>
            <th>Игрок</th>
            <th>Клуб</th>
            <th>Позиция</th>
            {% if show_price %}
              <th class="num">
                <a href="{{ url_for('epl.index', club=club_filter, position=pos_filter, sort='price', dir=next_dir) }}"
                   style="text-decoration:none;color:inherit">
                  Цена
                  {% if current_sort == 'price' %}
                    {{ '↑' if current_dir == 'asc' else '↓' }}
                  {% endif %}
                </a>
              </th>
            {% endif %}
            <th class="num">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for p in players %}
            {% set disabled = draft_completed or (next_user and current_user != next_user and not session.get('godmode')) %}
            <tr data-player-id="{{ p.playerId }}" data-can-pick="{{ '1' if p.canPick else '0' }}">
              <td class="wishlist-cell">
                <input type="checkbox" class="wishlist-toggle" data-player-id="{{ p.playerId }}" />
              </td>
              <td class="num">{{ p.playerId }}</td>
              <td>{{ p.shortName or p.fullName }}</td>
              <td>{{ p.clubName }}</td>
              <td>{{ p.position }}</td>
              {% if show_price %}<td class="num">{{ '%.1f'|format(p.price) }}</td>{% endif %}
              <td class="num">
                <form method="post" style="display:inline;">
                  <input type="hidden" name="player_id" value="{{ p.playerId }}" />
                  <button type="submit" {% if disabled %}disabled{% endif %}>Выбрать</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>Нет доступных игроков по текущим фильтрам.</p>
  {% endif %}
</div>

<style>
  .page { max-width: 1100px; margin: 0 auto; padding: 0 16px; }

  /* Тулбар */
  .topbar { display:flex; gap:24px; align-items:flex-start; justify-content:space-between; margin:10px 0 12px; }
  .topbar-left { display:flex; flex-direction:column; gap:8px; min-width:0; }
  .topbar-right { display:flex; flex-direction:column; align-items:flex-start; gap:8px; }
  .page-title { margin:0; font-size:22px; line-height:1.25; }
  .meta { display:flex; gap:8px; align-items:center; color:#444; flex-wrap:wrap; }

  /* Кнопки */
  .btn { display:inline-block; padding:8px 12px; border-radius:8px; border:1px solid #d7d7d7; background:#fff; text-decoration:none; color:#111; }
  .btn:hover { background:#f6f7fb; }
  .btn-link { text-decoration:none; color:#555; padding:6px 0; }
  .btn-danger { border-color:#e07070; color:#a50000; }
  .btn-danger:hover { background:#ffecec; }

  /* Бейджи */
  .badge { background:#222; color:#fff; border-radius:999px; padding:2px 10px; font-size:12px; }
  .badge-muted { background:#f0f0f0; color:#555; padding:4px 8px; border-radius: 8px; }

  /* Фильтры — всегда под тулбаром, на всю ширину */
  .filters {
    display:flex; flex-wrap:wrap; gap:10px 14px; align-items:flex-end;
    margin:0 0 12px; padding:8px 0; border-bottom:1px solid #ececec;
  }
  .fld { display:grid; gap:6px; }
  .fld label { font-size:13px; color:#555; }
  .fld select { min-width:160px; padding:6px 10px; border:1px solid #d7d7d7; border-radius:8px; background:#fff; }
  .toggles { display:flex; gap:12px; align-items:center; }
  .toggle { user-select:none; display:inline-flex; align-items:center; gap:8px; }

  /* Таблица игроков */
  .table-wrap { overflow:auto; border-radius:10px; border:1px solid #ececec; margin-top:6px; }
  table.players-table { width:100%; border-collapse:separate; border-spacing:0; font-size:14px; }
  .players-table thead th { background:#f6f7fb; padding:10px 12px; border-bottom:1px solid #e6e6e6; text-align:left; position:sticky; top:0; z-index:1; }
  .players-table th.num, .players-table td.num { text-align:right; }
  .players-table th.col-wl, .players-table td.wishlist-cell { width:46px; text-align:center; }
  .players-table tbody td { padding:12px 12px; border-bottom:1px solid #f0f0f0; vertical-align:middle; }
  .players-table tbody tr:nth-child(odd)  { background:#fafafa; }
  .players-table tbody tr:nth-child(even) { background:#f5f7fb; }
  .players-table tbody tr.is-wishlist {
    background: rgba(255,215,0,.18) !important;
    box-shadow: inset 0 0 0 1px rgba(180,140,0,.25);
  }
</style>

<script>
  // Автоприменение серверных фильтров по изменению select'ов
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('filters-form');
    if (!form) return;
    form.querySelectorAll('select').forEach(sel => {
      sel.addEventListener('change', () => form.submit());
    });
  });
</script>

<!-- Скрипт wishlist (серверное хранение) -->
<script src="{{ url_for('static', filename='wishlist.js') }}"></script>

{% endblock %}
