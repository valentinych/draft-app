{% extends "base.html" %}

{% block title %}Player Mapping - TOP-4 Draft{% endblock %}

{% block head %}
<!-- Bootstrap CSS and JS for this page -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
/* Override Bulma styles for this page */
.container-fluid { max-width: none !important; }
.table { border-collapse: separate !important; }
.btn { border: 1px solid transparent !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">üîó Player Mapping - MantraFootball ‚Üî Draft</h1>
            
            <!-- Status Panel -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 id="total-mantra" class="text-primary">-</h3>
                                <p class="mb-0">MantraFootball Players</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 id="total-draft" class="text-info">-</h3>
                                <p class="mb-0">Draft Players</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 id="matched-count" class="text-success">-</h3>
                                <p class="mb-0">Auto-Matched</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 id="match-rate" class="text-warning">-%</h3>
                                <p class="mb-0">Match Rate</p>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <div id="performance-note" class="alert alert-info" style="display: none; font-size: 0.9em;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <button id="load-preview-btn" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Load Mapping Preview
                            </button>
                            <button id="auto-map-high-confidence-btn" class="btn btn-info me-2" disabled>
                                <i class="fas fa-magic"></i> –°–º–∞–ø–∏—Ç—å –≤—Å–µ—Ö ‚â•99.99%
                            </button>
                            <button id="reset-mapping-btn" class="btn btn-warning me-2">
                                <i class="fas fa-trash"></i> Reset
                            </button>
                            <button id="confirm-all-btn" class="btn btn-success me-2" disabled>
                                <i class="fas fa-check"></i> Confirm All Auto-Matches
                            </button>
                            <button id="export-btn" class="btn btn-secondary" disabled>
                                <i class="fas fa-download"></i> Export Results
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="show-unmatched" checked>
                                <label class="form-check-label" for="show-unmatched">
                                    Show Unmatched Players
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="show-low-confidence" checked>
                                <label class="form-check-label" for="show-low-confidence">
                                    Show Low Confidence (&lt; 0.6)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cache Status -->
            <div class="alert alert-info" id="cache-status-alert" style="display: none;">
                <i class="fas fa-info-circle"></i> <strong>Cache Status:</strong>
                <span id="cache-status-text">Loading...</span>
            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading player mappings from cache (S3 + local)...</p>
            </div>

            <!-- Mapping Table -->
            <div class="card" id="mapping-table-card" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">Player Mappings</h5>
                    <small class="text-muted">Review and confirm automatic matches, or manually link players</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="mapping-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>MantraFootball Player</th>
                                    <th>Club / League</th>
                                    <th>Position</th>
                                    <th>Draft Match</th>
                                    <th>Confidence</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mapping-table-body">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Mapping Modal -->
<div class="modal fade" id="editMappingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Player Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-mapping-form">
                    <input type="hidden" id="edit-mantra-id">
                    <div class="mb-3">
                        <label class="form-label">MantraFootball Player</label>
                        <input type="text" class="form-control" id="edit-mantra-name" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Draft Player (from same club)</label>
                        <select class="form-select" id="edit-draft-player">
                            <option value="">Select a draft player...</option>
                        </select>
                        <small class="form-text text-muted">Only players from the same club are shown for accurate matching</small>
                    </div>
                    <div class="mb-3" style="display: none;">
                        <label class="form-label">Manual Entry (if not in list)</label>
                        <input type="text" class="form-control" id="edit-draft-name" placeholder="Enter draft player name">
                        <input type="text" class="form-control mt-2" id="edit-draft-club" placeholder="Enter club name">
                        <small class="form-text text-muted">Use this only if the player is not in the dropdown above</small>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-manual-entry">
                            Show Manual Entry
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-mapping-btn">Save Mapping</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentMappings = [];
let filteredMappings = [];

document.addEventListener('DOMContentLoaded', function() {
    const loadPreviewBtn = document.getElementById('load-preview-btn');
    const confirmAllBtn = document.getElementById('confirm-all-btn');
    const exportBtn = document.getElementById('export-btn');
    const showUnmatched = document.getElementById('show-unmatched');
    const showLowConfidence = document.getElementById('show-low-confidence');

    loadPreviewBtn.addEventListener('click', loadMappingPreview);
    document.getElementById('auto-map-high-confidence-btn').addEventListener('click', autoMapHighConfidence);
    document.getElementById('reset-mapping-btn').addEventListener('click', resetMapping);
    confirmAllBtn.addEventListener('click', confirmAllMappings);
    exportBtn.addEventListener('click', exportResults);
    showUnmatched.addEventListener('change', filterMappings);
    showLowConfidence.addEventListener('change', filterMappings);

    // Save mapping modal
    document.getElementById('save-mapping-btn').addEventListener('click', saveMapping);
    
    // Toggle manual entry
    document.getElementById('toggle-manual-entry').addEventListener('click', function() {
        const manualDiv = this.parentElement.previousElementSibling;
        const isHidden = manualDiv.style.display === 'none';
        
        if (isHidden) {
            manualDiv.style.display = 'block';
            this.textContent = 'Hide Manual Entry';
        } else {
            manualDiv.style.display = 'none';
            this.textContent = 'Show Manual Entry';
            // Clear manual inputs when hiding
            document.getElementById('edit-draft-name').value = '';
            document.getElementById('edit-draft-club').value = '';
        }
    });
});

async function loadMappingPreview() {
    const loadingIndicator = document.getElementById('loading-indicator');
    const mappingTableCard = document.getElementById('mapping-table-card');
    
    loadingIndicator.style.display = 'block';
    mappingTableCard.style.display = 'none';

    try {
        const response = await fetch('/top4/player-mapping/preview');
        
        // Check if response is ok
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Response not ok:', response.status, errorText);
            alert(`Server error (${response.status}): ${errorText.substring(0, 200)}...`);
            return;
        }
        
        // Try to parse as JSON
        let data;
        try {
            data = await response.json();
        } catch (jsonError) {
            const responseText = await response.text();
            console.error('JSON parse error:', jsonError);
            console.error('Response text:', responseText.substring(0, 500));
            alert(`Failed to parse JSON response. Response: ${responseText.substring(0, 200)}...`);
            return;
        }

        if (data.success) {
            // Process completed immediately
            currentMappings = data.mappings;
            updateStatusPanel(data);
            filterMappings();
            
            if (data.cache_status) {
                showCacheStatus(data.cache_status);
            }
            
            document.getElementById('auto-map-high-confidence-btn').disabled = false;
            document.getElementById('confirm-all-btn').disabled = false;
            document.getElementById('export-btn').disabled = false;
            mappingTableCard.style.display = 'block';
            loadingIndicator.style.display = 'none';
        } else if (data.in_progress) {
            // Process started, poll for status
            updateLoadingStatus(data.current_step, data.progress);
            pollMappingStatus();
        } else if (data.error) {
            console.error('Server returned error:', data.error);
            alert('Error: ' + data.error);
            loadingIndicator.style.display = 'none';
        }
    } catch (error) {
        console.error('Network or other error:', error);
        alert('Failed to load mappings: ' + error.message);
        loadingIndicator.style.display = 'none';
    }
}

function updateLoadingStatus(step, progress) {
    const loadingIndicator = document.getElementById('loading-indicator');
    const existingText = loadingIndicator.querySelector('p');
    if (existingText) {
        existingText.textContent = `${step} (${progress}%)`;
    } else {
        const p = document.createElement('p');
        p.textContent = `${step} (${progress}%)`;
        p.style.marginTop = '10px';
        loadingIndicator.appendChild(p);
    }
}

async function pollMappingStatus() {
    const maxPolls = 300; // 5 minutes max
    let polls = 0;
    
    const pollInterval = setInterval(async () => {
        polls++;
        
        try {
            const response = await fetch('/top4/player-mapping/status');
            const data = await response.json();
            
            if (data.in_progress) {
                updateLoadingStatus(data.current_step, data.progress);
                
                if (polls >= maxPolls) {
                    clearInterval(pollInterval);
                    alert('Mapping process is taking longer than expected. Please try again later.');
                    document.getElementById('loading-indicator').style.display = 'none';
                }
            } else {
                clearInterval(pollInterval);
                
                if (data.has_result) {
                    // Process completed, get the result
                    const resultResponse = await fetch('/top4/player-mapping/preview');
                    const resultData = await resultResponse.json();
                    
                    if (resultData.success) {
                        currentMappings = resultData.mappings;
                        updateStatusPanel(resultData);
                        filterMappings();
                        
                        if (resultData.cache_status) {
                            showCacheStatus(resultData.cache_status);
                        }
                        
                        document.getElementById('auto-map-high-confidence-btn').disabled = false;
                        document.getElementById('confirm-all-btn').disabled = false;
                        document.getElementById('export-btn').disabled = false;
                        document.getElementById('mapping-table-card').style.display = 'block';
                    }
                } else if (data.has_error) {
                    alert('Error: ' + data.error);
                }
                
                document.getElementById('loading-indicator').style.display = 'none';
            }
        } catch (error) {
            clearInterval(pollInterval);
            console.error('Error polling status:', error);
            alert('Error checking mapping status: ' + error.message);
            document.getElementById('loading-indicator').style.display = 'none';
        }
    }, 1000); // Poll every second
}

async function resetMapping() {
    if (!confirm('Are you sure you want to reset the mapping process? This will clear all current results.')) {
        return;
    }
    
    try {
        const response = await fetch('/top4/player-mapping/reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Clear the interface
            currentMappings = [];
            document.getElementById('mapping-table-card').style.display = 'none';
            document.getElementById('auto-map-high-confidence-btn').disabled = true;
            document.getElementById('confirm-all-btn').disabled = true;
            document.getElementById('export-btn').disabled = true;
            
            // Update status panel
            document.getElementById('total-mantra').textContent = '0';
            document.getElementById('total-draft').textContent = '0';
            document.getElementById('matched-count').textContent = '0';
            document.getElementById('match-rate').textContent = '0.0%';
            
            alert('Mapping reset successfully!');
        } else {
            alert('Error resetting mapping: ' + data.error);
        }
    } catch (error) {
        console.error('Error resetting mapping:', error);
        alert('Failed to reset mapping: ' + error.message);
    }
}

function updateStatusPanel(data) {
    document.getElementById('total-mantra').textContent = data.total_mantra_players;
    document.getElementById('total-draft').textContent = data.total_draft_players;
    document.getElementById('matched-count').textContent = data.matched_count;
    document.getElementById('match-rate').textContent = data.match_rate.toFixed(1) + '%';
    
    // Show performance note if available
    if (data.note) {
        const noteElement = document.getElementById('performance-note');
        if (noteElement) {
            let noteText = data.note;
            if (data.clubs_processed) {
                noteText += ` ‚Ä¢ Clubs processed: ${data.clubs_processed}`;
            }
            noteElement.textContent = noteText;
            noteElement.style.display = 'block';
        }
    }
}

function showCacheStatus(cacheStatus) {
    const alert = document.getElementById('cache-status-alert');
    const text = document.getElementById('cache-status-text');
    
    let statusText = '';
    if (cacheStatus.players) {
        statusText += `Players: ${cacheStatus.players.local ? 'Local ‚úÖ' : 'Local ‚ùå'} | ${cacheStatus.players.s3 ? 'S3 ‚úÖ' : 'S3 ‚ùå'}`;
    }
    if (cacheStatus.tournaments) {
        statusText += ` | Tournaments: ${cacheStatus.tournaments.local ? 'Local ‚úÖ' : 'Local ‚ùå'} | ${cacheStatus.tournaments.s3 ? 'S3 ‚úÖ' : 'S3 ‚ùå'}`;
    }
    
    text.textContent = statusText || 'Cache status unknown';
    alert.style.display = 'block';
}

function filterMappings() {
    const showUnmatched = document.getElementById('show-unmatched').checked;
    const showLowConfidence = document.getElementById('show-low-confidence').checked;

    filteredMappings = currentMappings.filter(mapping => {
        if (!mapping.auto_matched && !showUnmatched) return false;
        if (mapping.similarity_score < 0.6 && !showLowConfidence) return false;
        return true;
    });

    renderMappingTable();
}

function renderMappingTable() {
    const tbody = document.getElementById('mapping-table-body');
    tbody.innerHTML = '';

    filteredMappings.forEach((mapping, index) => {
        const row = document.createElement('tr');
        
        const confidenceClass = mapping.similarity_score >= 0.8 ? 'text-success' : 
                               mapping.similarity_score >= 0.6 ? 'text-warning' : 'text-danger';
        
        let statusBadge;
        if (mapping.is_unmapped) {
            statusBadge = '<span class="badge bg-danger">üö´ –ù–µ–∑–∞–º–∞–ø–ª–µ–Ω</span>';
        } else if (mapping.is_saved_to_s3) {
            const highConfidenceText = mapping.is_high_confidence ? ' (‚â•99.99%)' : '';
            statusBadge = `<span class="badge bg-primary">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ S3${highConfidenceText}</span>`;
        } else if (mapping.auto_matched) {
            statusBadge = '<span class="badge bg-success">Auto-matched</span>';
        } else if (mapping.total_remaining_options) {
            statusBadge = `<span class="badge bg-warning">‚ö†Ô∏è ${mapping.total_remaining_options} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</span>`;
        } else {
            statusBadge = '<span class="badge bg-secondary">No match</span>';
        }

        row.innerHTML = `
            <td>
                <strong>${mapping.mantra_name}</strong><br>
                <small class="text-muted">ID: ${mapping.mantra_id}</small>
            </td>
            <td>
                <div>${mapping.mantra_club}</div>
                <small class="text-muted">${mapping.mantra_league}</small>
            </td>
            <td>
                <span class="badge bg-info">${mapping.mantra_position}</span>
            </td>
            <td>
                ${mapping.is_unmapped ? 
                    '<span class="text-danger"><strong>üö´ –ò—Å–∫–ª—é—á–µ–Ω –∏–∑ –¥—Ä–∞—Ñ—Ç–∞</strong></span>' :
                    (mapping.draft_match ? 
                        `<strong>${mapping.draft_match.name}</strong><br><small class="text-muted">${mapping.draft_match.club}</small>` : 
                        (mapping.total_remaining_options ? 
                            `<span class="text-warning">‚ö†Ô∏è –ù–µ—Ç –∞–≤—Ç–æ—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è</span><br><small class="text-muted">${mapping.total_remaining_options} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–∑ ${mapping.mantra_club}</small>` :
                            '<span class="text-muted">No match</span>'))
                }
            </td>
            <td class="${confidenceClass}">
                ${mapping.is_unmapped ? 
                    '<span class="text-danger">N/A</span>' :
                    (mapping.similarity_score > 0 ? (mapping.similarity_score * 100).toFixed(1) + '%' : '-')
                }
            </td>
            <td>${statusBadge}</td>
            <td>
                ${mapping.is_saved_to_s3 ? 
                    '<span class="text-muted"><i class="fas fa-lock"></i> Locked</span>' :
                    `<button class="btn btn-sm btn-outline-primary" onclick="editMapping(${index})">
                        <i class="fas fa-edit"></i>
                    </button>
                    ${mapping.auto_matched ? 
                        `<button class="btn btn-sm btn-outline-success ms-1" onclick="confirmMapping(${index})">
                            <i class="fas fa-check"></i>
                        </button>` : ''
                    }`
                }
            </td>
        `;

        tbody.appendChild(row);
    });
}

function confirmMapping(index) {
    const mapping = filteredMappings[index];
    if (!mapping || !mapping.auto_matched) {
        alert('Invalid mapping or already confirmed');
        return;
    }
    
    // Mark as manually confirmed
    mapping.manually_confirmed = true;
    
    // Update the display
    filterMappings();
    
    alert('Mapping confirmed!');
}

function editMapping(index) {
    const mapping = filteredMappings[index];
    
    document.getElementById('edit-mantra-id').value = mapping.mantra_id;
    document.getElementById('edit-mantra-name').value = mapping.mantra_name;
    
    // Populate draft player dropdown
    populateDraftPlayerDropdown(mapping);
    
    // Set current values
    document.getElementById('edit-draft-name').value = mapping.draft_match ? mapping.draft_match.name : '';
    document.getElementById('edit-draft-club').value = mapping.draft_match ? mapping.draft_match.club : '';
    
    // Try to select current match in dropdown
    const draftPlayerSelect = document.getElementById('edit-draft-player');
    if (mapping.draft_match) {
        const optionValue = `${mapping.draft_match.name}|${mapping.draft_match.club}`;
        const option = Array.from(draftPlayerSelect.options).find(opt => opt.value === optionValue);
        if (option) {
            draftPlayerSelect.value = optionValue;
        }
    }
    
    new bootstrap.Modal(document.getElementById('editMappingModal')).show();
}

async function populateDraftPlayerDropdown(mapping) {
    const select = document.getElementById('edit-draft-player');
    
    // Clear existing options except the first one
    while (select.children.length > 1) {
        select.removeChild(select.lastChild);
    }
    
    // Get the MantraFootball player's club to filter by
    const mantraClub = mapping.mantra_club;
    
    let sameClubPlayers = [];
    
    // First, check if this mapping has remaining club options (for unmatched players)
    if (mapping.remaining_club_options && mapping.remaining_club_options.length > 0) {
        // Use the specific remaining options provided by the backend
        sameClubPlayers = mapping.remaining_club_options.map(option => ({
            name: option.name,
            club: option.club,
            similarity_score: option.similarity_score,
            source: 'remaining_options'
        }));
        
        console.log(`Using ${sameClubPlayers.length} remaining club options for ${mapping.mantra_name}`);
    } else {
        // Fallback: get all available draft players and filter by club
        let allDraftPlayers = [];
        
        // Extract from current mappings (these are confirmed available)
        currentMappings.forEach(m => {
            if (m.draft_match && m.draft_match.name && m.draft_match.club) {
                allDraftPlayers.push({
                    name: m.draft_match.name,
                    club: m.draft_match.club,
                    source: 'mapping'
                });
            }
        });
        
        // Try to get all draft players from backend
        try {
            const response = await fetch('/top4/player-mapping/all-draft-players');
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.players) {
                    data.players.forEach(player => {
                        allDraftPlayers.push({
                            name: player.name,
                            club: player.club,
                            source: 'backend'
                        });
                    });
                }
            }
        } catch (error) {
            console.warn('Could not load all draft players from backend:', error);
        }
        
        // Remove duplicates
        const uniquePlayers = allDraftPlayers.filter((player, index, self) => 
            index === self.findIndex(p => p.name === player.name && p.club === player.club)
        );
        
        // Filter players to only include those from the same club as MantraFootball player
        sameClubPlayers = uniquePlayers.filter(player => {
            // Use the club similarity function logic to determine if clubs match
            return isClubMatch(mantraClub, player.club);
        });
    }
    
    // Sort by similarity score if available, otherwise by name
    sameClubPlayers.sort((a, b) => {
        if (a.similarity_score !== undefined && b.similarity_score !== undefined) {
            return b.similarity_score - a.similarity_score; // Higher similarity first
        }
        return a.name.localeCompare(b.name);
    });
    
    // Always add the "Leave unmapped" option first
    const unmappedOption = document.createElement('option');
    unmappedOption.value = '__UNMAPPED__';
    unmappedOption.textContent = 'üö´ –û—Å—Ç–∞–≤–∏—Ç—å –Ω–µ–∑–∞–º–∞–ø–ª–µ–Ω–Ω—ã–º (–∏—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –¥—Ä–∞—Ñ—Ç–∞)';
    unmappedOption.style.fontStyle = 'italic';
    unmappedOption.style.color = '#dc3545';
    select.appendChild(unmappedOption);
    
    // Add separator
    const separator = document.createElement('option');
    separator.disabled = true;
    separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
    select.appendChild(separator);
    
    // Add club header
    if (sameClubPlayers.length > 0) {
        const header = document.createElement('option');
        header.disabled = true;
        
        // Different header text based on source
        if (mapping.remaining_club_options && mapping.remaining_club_options.length > 0) {
            header.textContent = `--- ${mantraClub} (${sameClubPlayers.length} –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤) ---`;
            header.style.color = '#ff8c00';  // Orange for remaining options
        } else {
            header.textContent = `--- ${mantraClub} (${sameClubPlayers.length} players) ---`;
        }
        
        header.style.fontWeight = 'bold';
        header.style.backgroundColor = '#f8f9fa';
        select.appendChild(header);
        
        // Add options to select
        sameClubPlayers.forEach((player, index) => {
            const option = document.createElement('option');
            option.value = `${player.name}|${player.club}`;
            
            // Show similarity score if available
            if (player.similarity_score !== undefined) {
                const scorePercent = (player.similarity_score * 100).toFixed(0);
                option.textContent = `${player.name} (${scorePercent}% —Å—Ö–æ–∂–µ—Å—Ç—å)`;
                
                // Color code by similarity
                if (player.similarity_score >= 0.7) {
                    option.style.color = '#28a745'; // Green for high similarity
                } else if (player.similarity_score >= 0.4) {
                    option.style.color = '#ffc107'; // Yellow for medium similarity
                } else {
                    option.style.color = '#6c757d'; // Gray for low similarity
                }
            } else {
                option.textContent = player.name;  // Just name since club is obvious
            }
            
            select.appendChild(option);
        });
    } else {
        // If no players found, add a message
        const noPlayersOption = document.createElement('option');
        noPlayersOption.disabled = true;
        noPlayersOption.textContent = `No players found for ${mantraClub}`;
        noPlayersOption.style.fontStyle = 'italic';
        select.appendChild(noPlayersOption);
    }
}

// Helper function to determine if clubs match (simplified version of backend logic)
function isClubMatch(mantraClub, draftClub) {
    if (!mantraClub || !draftClub) return false;
    
    // Exact match
    if (mantraClub.toLowerCase() === draftClub.toLowerCase()) return true;
    
    // Common club name mappings for quick matching
    const clubMappings = {
        // Spanish clubs
        'real madrid': ['—Ä–µ–∞–ª –º–∞–¥—Ä–∏–¥', 'real madrid', '—Ä–µ–∞–ª'],
        'barcelona': ['–±–∞—Ä—Å–µ–ª–æ–Ω–∞', 'barcelona', '–±–∞—Ä—Å–∞'],
        'atletico madrid': ['–∞—Ç–ª–µ—Ç–∏–∫–æ –º–∞–¥—Ä–∏–¥', '–∞—Ç–ª–µ—Ç–∏–∫–æ', 'atletico madrid'],
        'valencia': ['–≤–∞–ª–µ–Ω—Å–∏—è', 'valencia'],
        'sevilla': ['—Å–µ–≤–∏–ª—å—è', 'sevilla'],
        'villarreal': ['–≤–∏–ª—å—è—Ä—Ä–µ–∞–ª', 'villarreal'],
        'real sociedad': ['—Ä–µ–∞–ª —Å–æ—Å—å–µ–¥–∞–¥', 'real sociedad'],
        'real betis': ['–±–µ—Ç–∏—Å', 'real betis'],
        'athletic bilbao': ['–∞—Ç–ª–µ—Ç–∏–∫ –±–∏–ª—å–±–∞–æ', '–∞—Ç–ª–µ—Ç–∏–∫', 'athletic bilbao'],
        'deportivo alaves': ['–∞–ª–∞–≤–µ—Å', 'alaves', 'deportivo alaves'],
        'getafe': ['—Ö–µ—Ç–∞—Ñ–µ', 'getafe'],
        'espanyol': ['—ç—Å–ø–∞–Ω—å–æ–ª', 'espanyol'],
        'celta vigo': ['—Å–µ–ª—å—Ç–∞', 'celta vigo'],
        'osasuna': ['–æ—Å–∞—Å—É–Ω–∞', 'osasuna'],
        'las palmas': ['–ª–∞—Å –ø–∞–ª—å–º–∞—Å', 'las palmas'],
        'girona': ['–∂–∏—Ä–æ–Ω–∞', 'girona'],
        'rayo vallecano': ['—Ä–∞–π–æ –≤–∞–ª—å–µ–∫–∞–Ω–æ', 'rayo vallecano'],
        
        // English clubs  
        'manchester city': ['–º–∞–Ω—á–µ—Å—Ç–µ—Ä —Å–∏—Ç–∏', 'manchester city'],
        'manchester united': ['–º–∞–Ω—á–µ—Å—Ç–µ—Ä —é–Ω–∞–π—Ç–µ–¥', 'manchester united'],
        'liverpool': ['–ª–∏–≤–µ—Ä–ø—É–ª—å', 'liverpool'],
        'chelsea': ['—á–µ–ª—Å–∏', 'chelsea'],
        'arsenal': ['–∞—Ä—Å–µ–Ω–∞–ª', 'arsenal'],
        'tottenham': ['—Ç–æ—Ç—Ç–µ–Ω—Ö—ç–º', 'tottenham'],
        'newcastle': ['–Ω—å—é–∫–∞—Å–ª', 'newcastle'],
        'aston villa': ['–∞—Å—Ç–æ–Ω –≤–∏–ª–ª–∞', 'aston villa'],
        'west ham': ['–≤–µ—Å—Ç —Ö—ç–º', 'west ham'],
        'leeds united': ['–ª–∏–¥—Å', 'leeds united', 'leeds'],
        'everton': ['—ç–≤–µ—Ä—Ç–æ–Ω', 'everton'],
        'leicester city': ['–ª–µ—Å—Ç–µ—Ä', 'leicester city'],
        'crystal palace': ['–∫—Ä–∏—Å—Ç–∞–ª –ø—ç–ª–∞—Å', 'crystal palace'],
        'brighton': ['–±—Ä–∞–π—Ç–æ–Ω', 'brighton'],
        'burnley': ['–±–µ—Ä–Ω–ª–∏', 'burnley'],
        'southampton': ['—Å–∞—É—Ç–≥–µ–º–ø—Ç–æ–Ω', 'southampton'],
        'nottingham forest': ['–Ω–æ—Ç—Ç–∏–Ω–≥–µ–º —Ñ–æ—Ä–µ—Å—Ç', 'nottingham forest'],
        'fulham': ['—Ñ—É–ª—Ö—ç–º', 'fulham'],
        'bournemouth': ['–±–æ—Ä–Ω–º—É—Ç', 'bournemouth'],
        'brentford': ['–±—Ä–µ–Ω—Ç—Ñ–æ—Ä–¥', 'brentford'],
        'wolverhampton': ['–≤—É–ª–≤–µ—Ä—Ö—ç–º–ø—Ç–æ–Ω', 'wolverhampton'],
        
        // German clubs
        'bayern munich': ['–±–∞–≤–∞—Ä–∏—è', 'bayern munich', 'bayern'],
        'borussia dortmund': ['–±–æ—Ä—É—Å—Å–∏—è –¥', 'borussia dortmund', '–±–æ—Ä—É—Å—Å–∏—è –¥–æ—Ä—Ç–º—É–Ω–¥'],
        'borussia monchengladbach': ['–±–æ—Ä—É—Å—Å–∏—è –º', 'borussia mbach', 'borussia monchengladbach', '–±–æ—Ä—É—Å—Å–∏—è –º—ë–Ω—Ö–µ–Ω–≥–ª–∞–¥–±–∞—Ö'],
        'rb leipzig': ['—Ä–± –ª–µ–π–ø—Ü–∏–≥', 'rb leipzig', '–ª–µ–π–ø—Ü–∏–≥'],
        'bayer leverkusen': ['–±–∞–π–µ—Ä', 'bayer leverkusen', '–±–∞–π–µ—Ä –ª–µ–≤–µ—Ä–∫—É–∑–µ–Ω'],
        'wolfsburg': ['–≤–æ–ª—å—Ñ—Å–±—É—Ä–≥', 'wolfsburg'],
        'eintracht frankfurt': ['–∞–π–Ω—Ç—Ä–∞—Ö—Ç —Ñ', 'eintracht frankfurt', '–∞–π–Ω—Ç—Ä–∞—Ö—Ç', '—Ñ—Ä–∞–Ω–∫—Ñ—É—Ä—Ç'],
        'stuttgart': ['—à—Ç—É—Ç–≥–∞—Ä—Ç', 'stuttgart'],
        'freiburg': ['—Ñ—Ä–∞–π–±—É—Ä–≥', 'freiburg'],
        'hoffenheim': ['—Ö–æ—Ñ—Ñ–µ–Ω—Ö–∞–π–º', 'hoffenheim'],
        'mainz': ['–º–∞–π–Ω—Ü', 'mainz'],
        'fc koln': ['–∫—ë–ª—å–Ω', 'fc koln', 'koln', 'cologne'],
        'st pauli': ['—Å–∞–Ω–∫—Ç-–ø–∞—É–ª–∏', 'st pauli', '—Å–∞–Ω–∫—Ç –ø–∞—É–ª–∏'],
        'hamburger sv': ['–≥–∞–º–±—É—Ä–≥', 'hamburger sv', 'hamburg'],
        'werder bremen': ['–≤–µ—Ä–¥–µ—Ä', 'werder bremen', '–±—Ä–µ–º–µ–Ω'],
        'hertha berlin': ['–≥–µ—Ä—Ç–∞', 'hertha berlin'],
        'augsburg': ['–∞—É–≥—Å–±—É—Ä–≥', 'augsburg'],
        'union berlin': ['—É–Ω–∏–æ–Ω –±–µ—Ä–ª–∏–Ω', 'union berlin'],
        'schalke 04': ['—à–∞–ª—å–∫–µ', 'schalke 04', 'schalke'],
        'fortuna dusseldorf': ['—Ñ–æ—Ä—Ç—É–Ω–∞', 'fortuna dusseldorf'],
        
        // Italian clubs
        'juventus': ['—é–≤–µ–Ω—Ç—É—Å', 'juventus'],
        'ac milan': ['–º–∏–ª–∞–Ω', 'ac milan', 'milan'],
        'inter milan': ['–∏–Ω—Ç–µ—Ä', 'inter milan', 'inter'],
        'napoli': ['–Ω–∞–ø–æ–ª–∏', 'napoli'],
        'as roma': ['—Ä–æ–º–∞', 'as roma', 'roma'],
        'lazio': ['–ª–∞—Ü–∏–æ', 'lazio'],
        'atalanta': ['–∞—Ç–∞–ª–∞–Ω—Ç–∞', 'atalanta'],
        'fiorentina': ['—Ñ–∏–æ—Ä–µ–Ω—Ç–∏–Ω–∞', 'fiorentina'],
        'torino': ['—Ç–æ—Ä–∏–Ω–æ', 'torino'],
        'bologna': ['–±–æ–ª–æ–Ω—å—è', 'bologna'],
        'sassuolo': ['—Å–∞—Å—Å—É–æ–ª–æ', 'sassuolo'],
        'udinese': ['—É–¥–∏–Ω–µ–∑–µ', 'udinese'],
        'hellas verona': ['–≤–µ—Ä–æ–Ω–∞', 'hellas verona', 'verona'],
        'genoa': ['–¥–∂–µ–Ω–æ–∞', 'genoa'],
        'lecce': ['–ª–µ—á—á–µ', 'lecce'],
        'parma': ['–ø–∞—Ä–º–∞', 'parma'],
        'cagliari': ['–∫–∞–ª—å—è—Ä–∏', 'cagliari'],
        'venezia': ['–≤–µ–Ω–µ—Ü–∏—è', 'venezia'],
        'como': ['–∫–æ–º–æ', 'como']
    };
    
    const mantraLower = mantraClub.toLowerCase();
    const draftLower = draftClub.toLowerCase();
    
    // Check mappings
    for (const [key, variants] of Object.entries(clubMappings)) {
        if (variants.includes(mantraLower) && variants.includes(draftLower)) {
            return true;
        }
    }
    
    // Basic similarity check (for cases not in mappings)
    if (mantraLower.includes(draftLower) || draftLower.includes(mantraLower)) {
        // But avoid false positives like milan-inter
        if ((mantraLower.includes('milan') && draftLower.includes('inter')) ||
            (mantraLower.includes('inter') && draftLower.includes('milan'))) {
            return false;
        }
        return true;
    }
    
    return false;
}

async function saveMapping() {
    const mantraId = document.getElementById('edit-mantra-id').value;
    const draftPlayerSelect = document.getElementById('edit-draft-player');
    
    let draftName, draftClub, isUnmapped = false;
    
    // Check if "Leave unmapped" option was selected
    if (draftPlayerSelect.value === '__UNMAPPED__') {
        draftName = '__UNMAPPED__';
        draftClub = '__UNMAPPED__';
        isUnmapped = true;
    }
    // Check if a player was selected from dropdown
    else if (draftPlayerSelect.value && draftPlayerSelect.value.includes('|')) {
        const [name, club] = draftPlayerSelect.value.split('|');
        draftName = name;
        draftClub = club;
    } else {
        // Use manual entry
        draftName = document.getElementById('edit-draft-name').value;
        draftClub = document.getElementById('edit-draft-club').value;
    }

    if (!draftName.trim() && !isUnmapped) {
        alert('Please select a draft player from the dropdown or enter manually');
        return;
    }

    try {
        const response = await fetch('/top4/player-mapping/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mantra_id: mantraId,
                draft_name: draftName.trim(),
                draft_club: draftClub.trim(),
                is_unmapped: isUnmapped,
                timestamp: new Date().toISOString()
            })
        });

        const data = await response.json();
        if (data.success) {
            // Update local mapping
            const mapping = currentMappings.find(m => m.mantra_id == mantraId);
            if (mapping) {
                if (isUnmapped) {
                    mapping.draft_match = null;
                    mapping.similarity_score = 0;
                    mapping.auto_matched = false;
                    mapping.is_unmapped = true;
                } else {
                    mapping.draft_match = { name: draftName.trim(), club: draftClub.trim() };
                    mapping.similarity_score = 1.0;
                    mapping.auto_matched = true;
                    mapping.is_unmapped = false;
                }
            }
            
            filterMappings();
            bootstrap.Modal.getInstance(document.getElementById('editMappingModal')).hide();
            alert('Mapping updated successfully!');
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Failed to save mapping: ' + error.message);
    }
}

async function autoMapHighConfidence() {
    // Check if we have any mappings loaded
    if (!currentMappings || currentMappings.length === 0) {
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–∞–ø–ø–∏–Ω–≥ —Å –ø–æ–º–æ—â—å—é "Load Mapping Preview"');
        return;
    }

    // Find all mappings with similarity >= 0.9999 (99.99%)
    const highConfidenceMappings = currentMappings.filter(m => 
        m.auto_matched && m.similarity_score >= 0.9999 && !m.is_saved_to_s3
    );

    if (highConfidenceMappings.length === 0) {
        // Check if there are any high confidence mappings already saved
        const alreadySaved = currentMappings.filter(m => 
            m.is_saved_to_s3 && m.similarity_score >= 0.9999
        );
        
        if (alreadySaved.length > 0) {
            alert(`–í—Å–µ –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (${alreadySaved.length}) —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ S3.\n\n–ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∞–ø–ø–∏–Ω–≥ –∑–∞–Ω–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π.`);
        } else {
            alert('–ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é ‚â•99.99%.\n\n–í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ —Å–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥ –∏–ª–∏ –≤—Å–µ –æ—á–µ–≤–∏–¥–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —É–∂–µ –Ω–∞–π–¥–µ–Ω—ã.');
        }
        return;
    }

    if (!confirm(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ${highConfidenceMappings.length} –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π (‚â•99.99%) –≤ AWS S3?\n\n–≠—Ç–æ –∏—Å–∫–ª—é—á–∏—Ç –∏—Ö –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –ø—Ä–æ–≥–æ–Ω–æ–≤ –º–∞–ø–ø–∏–Ω–≥–∞.`)) {
        return;
    }

    try {
        // Disable button during processing
        const btn = document.getElementById('auto-map-high-confidence-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        const response = await fetch('/top4/player-mapping/auto-map-high-confidence', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mappings: highConfidenceMappings,
                timestamp: new Date().toISOString()
            })
        });

        const data = await response.json();
        if (data.success) {
            alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${data.saved_count} –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤ AWS S3!\n\n–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ –∑–∞–Ω–æ–≤–æ - —ç—Ç–∏ –ø–∞—Ä—ã –±—É–¥—É—Ç –∏—Å–∫–ª—é—á–µ–Ω—ã.`);
            
            // Update local mappings to reflect saved status
            highConfidenceMappings.forEach(mapping => {
                mapping.is_saved_to_s3 = true;
            });
            
            // Refresh the table
            filterMappings();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
    } finally {
        // Re-enable button
        const btn = document.getElementById('auto-map-high-confidence-btn');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic"></i> –°–º–∞–ø–∏—Ç—å –≤—Å–µ—Ö ‚â•99.99%';
    }
}

async function confirmAllMappings() {
    const confirmedMappings = currentMappings.filter(m => m.auto_matched).map(m => ({
        ...m,
        confirmed: true
    }));

    if (confirmedMappings.length === 0) {
        alert('No auto-matched players to confirm');
        return;
    }

    if (!confirm(`Confirm ${confirmedMappings.length} automatic mappings?`)) {
        return;
    }

    try {
        const response = await fetch('/top4/player-mapping/confirm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mappings: confirmedMappings,
                timestamp: new Date().toISOString()
            })
        });

        const data = await response.json();
        if (data.success) {
            alert(`Successfully confirmed ${data.confirmed_count} player mappings!`);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Failed to confirm mappings: ' + error.message);
    }
}

function exportResults() {
    const csvContent = "data:text/csv;charset=utf-8," + 
        "MantraFootball ID,MantraFootball Name,MantraFootball Club,Position,League,Draft Name,Draft Club,Confidence,Status\n" +
        currentMappings.map(m => 
            `${m.mantra_id},"${m.mantra_name}","${m.mantra_club}","${m.mantra_position}","${m.mantra_league}","${m.draft_match ? m.draft_match.name : ''}","${m.draft_match ? m.draft_match.club : ''}",${(m.similarity_score * 100).toFixed(1)}%,${m.auto_matched ? 'Auto-matched' : 'No match'}`
        ).join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "player_mappings.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}
