{% extends "base.html" %}
{% block title %}–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¢–æ–ø-4{% endblock %}
{% block content %}
<h1 class="title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ª–∏–≥</h1>

{# Transfer window status #}
{% if transfer_info and transfer_info.window_active %}
<div class="card" style="margin-bottom: 20px; border: 2px solid #28a745;">
  <div class="card-title" style="background: #28a745; color: white;">
    üîÑ –¢—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
  </div>
  <div class="card-body">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <p><strong>–¢–µ–∫—É—â–∏–π —Ö–æ–¥:</strong> {{ transfer_info.current_manager }} ({{ transfer_info.current_phase }})</p>
        <p><strong>–†–∞—É–Ω–¥:</strong> {{ transfer_info.current_round }}/{{ transfer_info.total_rounds }}</p>
        {% if transfer_info.managers_order %}
        <p><strong>–û—á–µ—Ä–µ–¥–Ω–æ—Å—Ç—å:</strong> {{ transfer_info.managers_order|join(' ‚Üí ') }}</p>
        {% endif %}
      </div>
      <div>
        <a href="{{ url_for('transfers.transfer_history', draft_type='top4') }}" class="btn btn-primary">
          üìã –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤
        </a>
      </div>
    </div>
    
    {# Progress bar for current round #}
    {% if transfer_info.managers_order %}
    {% set total_in_round = transfer_info.managers_order|length %}
    {% set completed_in_round = transfer_info.current_manager_index %}
    {% set progress_percent = (completed_in_round / total_in_round * 100) if total_in_round > 0 else 0 %}
    <div style="margin-top: 15px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
        <span><strong>–ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞—É–Ω–¥–∞ {{ transfer_info.current_round }}:</strong></span>
        <span>{{ completed_in_round }}/{{ total_in_round }}</span>
      </div>
      <div style="background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden;">
        <div style="background: #28a745; height: 100%; width: {{ progress_percent }}%; transition: width 0.3s;"></div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% elif transfer_info %}
<div class="card" style="margin-bottom: 20px; border: 2px solid #6c757d;">
  <div class="card-title" style="background: #6c757d; color: white;">
    ‚è∏Ô∏è –¢—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ
  </div>
  <div class="card-body">
    <p>–¢—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∑–∞–∫—Ä—ã—Ç–æ. –û–∂–∏–¥–∞–π—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ —Å–ª–µ–¥—É—é—â–µ–º —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ.</p>
    <a href="{{ url_for('transfers.transfer_history', draft_type='top4') }}" class="btn">
      üìã –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–æ–≤
    </a>
  </div>
</div>
{% endif %}

<style>
.transfer-window {
  background-color: #fef0e7 !important;
  font-style: italic;
  color: #8b4513;
  text-align: center;
}
.transfer-window td {
  font-weight: bold;
}
</style>

{% set transfer_windows = {4: 3, 8: 1, 12: 2, 16: 1, 20: 3, 24: 1, 28: 2} %}

<div class="columns is-multiline">
  {% for league, rounds in schedule.items() %}
  <div class="column is-half-tablet is-one-quarter-desktop">
    <h2 class="subtitle">{{ league }}</h2>
    <table class="table is-bordered is-striped is-narrow is-fullwidth">
      <tbody>
      {% for r in rounds %}
        <tr class="{% if r.skip %}has-background-danger-light{% elif r.closed %}has-background-info-light{% elif r.current %}has-background-success-light{% endif %}">
          <td>–¢—É—Ä {{ r.round }} ({{ 'GW' ~ r.gw if r.gw is not none else '‚Äî' }})</td>
          <td>{{ r.date }}</td>
        </tr>
        {# Add transfer window after specific GWs #}
        {% if r.gw and r.gw in transfer_windows %}
        <tr class="transfer-window">
          <td colspan="2">transfers ({{ transfer_windows[r.gw] }})</td>
        </tr>
        {% endif %}
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% endfor %}
</div>
{% endblock %}
