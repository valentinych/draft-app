{% extends "base.html" %}
{% block title %}Лайнапы{% endblock %}
{% block content %}
<h1 class="title">Лайнапы GW{{ round }}</h1>
{% if gw_rounds %}
<div class="mb-4">
  {% for league, rnd in gw_rounds.items() %}
  <span class="mr-2">{{ league }} – Тур {{ rnd if rnd else '—' }}</span>
  {% endfor %}
</div>
{% endif %}
<form method="get" class="mb-4">
  <label class="label">GW</label>
  <div class="field has-addons">
    <div class="control"><input class="input" type="number" name="round" value="{{ round }}" min="1" style="width:90px"/></div>
    <div class="control"><button class="button is-link" type="submit">Показать</button></div>
  </div>
</form>
<div id="lineups-container">Загрузка...</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const container = document.getElementById('lineups-container');
  const url = `{{ url_for('top4.lineups_data') }}?round={{ round }}`;

  const render = data => {
    const managers = data.managers || [];
    const lineups = data.lineups || {};
    const posOrder = { GKP: 0, GK: 0, DEF: 1, MID: 2, FWD: 3 };

    const table = document.createElement('table');
    table.className = 'table is-striped is-compact';

    const thead = document.createElement('thead');
    const headRow = document.createElement('tr');
    managers.forEach(m => {
      const th = document.createElement('th');
      th.textContent = m;
      const total = lineups[m] && lineups[m].total;
      if (total !== undefined && total !== null) {
        const span = document.createElement('span');
        span.style.backgroundColor = '#006400';
        span.style.color = 'white';
        span.style.padding = '0 4px';
        span.style.borderRadius = '3px';
        span.textContent = total;
        th.appendChild(document.createTextNode(' '));
        th.appendChild(span);
      }
      headRow.appendChild(th);
    });
    thead.appendChild(headRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    const bodyRow = document.createElement('tr');
    managers.forEach((m, idx) => {
      const td = document.createElement('td');
      const players = (lineups[m] && lineups[m].players) || [];
      const hue = idx * 60;
      const c1 = `hsl(${hue}, 70%, 90%)`;
      const c2 = `hsl(${hue}, 70%, 80%)`;
      players.sort((a, b) => {
        const oa = posOrder[a.pos] ?? 99;
        const ob = posOrder[b.pos] ?? 99;
        return oa - ob;
      });
      let lastPos = null;
      players.forEach((p, j) => {
        if (lastPos && p.pos !== lastPos) {
          const hr = document.createElement('hr');
          hr.className = 'my-1';
          td.appendChild(hr);
        }
        lastPos = p.pos;
        const rowColor = j % 2 === 0 ? c1 : c2;
        const div = document.createElement('div');
        div.className = 'is-flex is-justify-content-space-between';
        div.style.backgroundColor = rowColor;
        const spanName = document.createElement('span');
        spanName.textContent = `${p.name} (${p.pos})`;
        const spanPts = document.createElement('span');
        spanPts.className = 'has-text-right';
        spanPts.style.minWidth = '2em';
        spanPts.textContent = p.points;
        div.appendChild(spanName);
        div.appendChild(spanPts);
        td.appendChild(div);
      });
      bodyRow.appendChild(td);
    });
    tbody.appendChild(bodyRow);
    table.appendChild(tbody);

    container.innerHTML = '';
    container.appendChild(table);
    if (data.debug && data.debug.length) {
      const dbg = document.createElement('pre');
      dbg.style.whiteSpace = 'pre-wrap';
      dbg.style.marginTop = '1em';
      dbg.textContent = data.debug.join('\n');
      container.appendChild(dbg);
    }
    const raw = document.createElement('pre');
    raw.style.whiteSpace = 'pre-wrap';
    raw.style.marginTop = '1em';
    raw.textContent = JSON.stringify(data, null, 2);
    container.appendChild(raw);
  };

  const fetchData = () => {
    fetch(url)
      .then(resp => resp.json())
      .then(data => {
        if (data.status === 'processing') {
          container.textContent = 'Обработка данных...';
          setTimeout(fetchData, 2000);
          return;
        }
        console.log('lineups data', data);
        render(data);
      })
      .catch(() => {
        container.textContent = 'Ошибка загрузки данных';
      });
  };

  fetchData();
});
</script>
{% endblock %}

