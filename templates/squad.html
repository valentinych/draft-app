{% extends "base.html" %}
{% block title %}Мой состав — EPL Драфт{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/draft.css') }}"/>
<link rel="stylesheet" href="{{ url_for('static', filename='css/squad.css') }}"/>
<h1 class="title">Мой состав на Gameweek {{ gw }}</h1>
{% if deadline %}
<h2 style="color:red; font-size:2em;">Дедлайн: {{ deadline.strftime('%Y-%m-%d %H:%M') }} UTC</h2>
{% endif %}
<form method="post" id="lineup-form">
  <div class="field is-grouped">
    <div class="control">
      <label class="label">Gameweek</label>
      <input class="input" type="number" name="gw" value="{{ gw }}" min="1" />
    </div>
    <div class="control">
      <label class="label">Схема</label>
      <div class="select">
        <select id="formation" name="formation">
          <option value="auto" {% if formation=='auto' %}selected{% endif %}>Как бог пошлёт</option>
          {% for f in formations %}
            <option value="{{ f }}" {% if f==formation %}selected{% endif %}>{{ f }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
  <div class="columns">
    <div class="column is-half">
      <div class="squad-header">
        <h2 class="subtitle">Состав</h2>
        <button type="button" id="view-toggle" class="button is-small">Список</button>
      </div>
      <div id="roster" class="player-list">
        {% for pos in ['GK','DEF','MID','FWD'] %}
          <div class="roster-line" id="roster-{{ pos }}">
            {% for p in roster if p.position == pos %}
              <div class="player" data-id="{{ p.playerId }}" data-pos="{{ p.position }}"
                   data-name="{{ p.shortName or p.fullName }}"
                   data-fixture="{{ p.fixture }}"
                   data-news="{{ p.news or '' }}"
                   data-stats='{{ p.stats|tojson|safe }}'>
                <img src="{{ p.photo }}" alt="" onerror="this.onerror=null; this.src='https://static.wikitide.net/rytpwiki/thumb/2/20/%D0%A1%D0%B2%D0%B8%D0%B4%D0%B5%D1%82%D0%B5%D0%BB%D1%8C_%D0%B8%D0%B7_%D0%A4%D1%80%D1%8F%D0%B7%D0%B8%D0%BD%D0%BE.png/250px-%D0%A1%D0%B2%D0%B8%D0%B4%D0%B5%D1%82%D0%B5%D0%BB%D1%8C_%D0%B8%D0%B7_%D0%A4%D1%80%D1%8F%D0%B7%D0%B8%D0%BD%D0%BE.png';" />
                {% set st = p.status or 'a' %}
                {% if st != 'a' %}
                  {% set ch = p.chance or 0 %}
                  {% if ch >= 75 %}
                    <span class="flag flag-yellow"></span>
                  {% elif ch >= 50 %}
                    <span class="flag flag-orange"></span>
                  {% else %}
                    <span class="flag flag-red"></span>
                  {% endif %}
                {% else %}
                  <span class="info-icon">i</span>
                {% endif %}
                <span>{{ p.shortName or p.fullName }}</span>
                <small>{{ p.position }}{% if p.fixture %} {{ p.fixture }}{% endif %}</small>
              </div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>

      <div id="roster-table-wrap" style="display:none;">
        <table id="roster-table" class="tbl">
          <thead>
            <tr>
              <th>Игрок</th>
              <th class="num">FP 2025/26</th>
              <th>Статус</th>
              {% if transfer_active and transfer_user == session.get('user_name') %}<th>Transfer Out</th>{% endif %}
            </tr>
          </thead>
          <tbody>
            {% for p in roster %}
            <tr data-id="{{ p.playerId }}" data-pos="{{ p.position }}">
              <td>{{ p.shortName or p.fullName }}{% if p.fixture %} {{ p.fixture }}{% endif %}</td>
              <td class="num">{{ (p.fp_current or p.stats.points or 0)|int }}</td>
              <td>
                {% if p.status and p.status != 'a' %}
                  {% set ch = p.chance or 0 %}
                  {% if ch >= 75 %}
                    <span class="status-circle status-yellow"></span>
                  {% elif ch >= 50 %}
                    <span class="status-circle status-orange"></span>
                  {% else %}
                    <span class="status-circle status-red"></span>
                  {% endif %}
                  {{ p.news }}
                {% endif %}
              </td>
              {% if transfer_active and transfer_user == session.get('user_name') %}
              <td>
                <form method="post" action="{{ url_for('epl.do_transfer') }}" class="transfer-form">
                  <input type="hidden" name="out" value="{{ p.playerId }}" />
                  <button type="submit" class="button is-small">Transfer Out</button>
                </form>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="column is-half">
      <h2 class="subtitle">Стартовые 11</h2>
      <div id="lineup" class="lineup" data-editable="{{ '1' if editable else '0' }}">
        <div class="lineup-pos" data-pos="GK">
          <h3>GK</h3>
          <div class="slots" id="slot-GK"></div>
        </div>
        <div class="lineup-pos" data-pos="DEF">
          <h3>DEF</h3>
          <div class="slots" id="slot-DEF"></div>
        </div>
        <div class="lineup-pos" data-pos="MID">
          <h3>MID</h3>
          <div class="slots" id="slot-MID"></div>
        </div>
        <div class="lineup-pos" data-pos="FWD">
          <h3>FWD</h3>
          <div class="slots" id="slot-FWD"></div>
        </div>
        <div class="lineup-pos" data-pos="BENCH">
          <h3>Запасые</h3>
          <div class="slots" id="slot-BENCH"></div>
        </div>
      </div>
    </div>
  </div>
  <input type="hidden" name="player_ids" id="player_ids" />
  <input type="hidden" name="bench_ids" id="bench_ids" />
  <div class="field">
    <button type="submit" class="button is-primary" {% if not editable %}disabled{% endif %}>Сохранить</button>
  </div>
</form>
<script id="lineup-data" type="application/json">{{ lineup|map(attribute='playerId')|list|tojson }}</script>
<script id="bench-data" type="application/json">{{ bench|map(attribute='playerId')|list|tojson }}</script>
<script id="formation-list" type="application/json">{{ formations|tojson }}</script>

<div id="player-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" data-close="1"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="pm-title">
    <div class="modal-header">
      <div id="pm-title" class="modal-title">Информация</div>
      <button type="button" class="modal-close" data-close="1" aria-label="Закрыть">×</button>
    </div>
    <div class="modal-body">
      <div class="player-head">
        <img id="pm-photo" src="" alt="" class="player-photo" style="display:none;">
        <div id="pm-name" class="player-name"></div>
      </div>
      <div id="pm-news" class="muted" style="margin-bottom:8px;"></div>
      <div id="pm-stats"></div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/squad.js') }}"></script>
<script>
// Универсальный обработчик ошибок для всех изображений на странице
document.addEventListener('DOMContentLoaded', function() {
  const placeholderUrl = 'https://static.wikitide.net/rytpwiki/thumb/2/20/%D0%A1%D0%B2%D0%B8%D0%B4%D0%B5%D1%82%D0%B5%D0%BB%D1%8C_%D0%B8%D0%B7_%D0%A4%D1%80%D1%8F%D0%B7%D0%B8%D0%BD%D0%BE.png/250px-%D0%A1%D0%B2%D0%B8%D0%B4%D0%B5%D1%82%D0%B5%D0%BB%D1%8C_%D0%B8%D0%B7_%D0%A4%D1%80%D1%8F%D0%B7%D0%B8%D0%BD%D0%BE.png';
  
  // Функция для проверки, является ли изображение пустым
  function isImageEmpty(img) {
    // Проверяем размер изображения (пустые фото обычно очень маленькие)
    return img.naturalWidth <= 1 && img.naturalHeight <= 1;
  }
  
  // Обработчик для всех изображений в составе
  function setupImageErrorHandlers() {
    const images = document.querySelectorAll('#roster img, #lineup img, #player-modal img');
    images.forEach(function(img) {
      // Проверяем, не установлен ли уже обработчик
      if (!img.hasAttribute('data-error-handler-set')) {
        img.setAttribute('data-error-handler-set', 'true');
        
        // Обработчик ошибок загрузки
        img.addEventListener('error', function() {
          // Проверяем, что это не placeholder уже
          if (this.src !== placeholderUrl && !this.src.includes('wikitide')) {
            this.src = placeholderUrl;
            // Для placeholder используем contain, чтобы изображение полностью помещалось по высоте
            this.style.objectFit = 'contain';
            this.style.objectPosition = 'center';
          }
        });
        
        // Обработчик для проверки пустых изображений после загрузки
        img.addEventListener('load', function() {
          // Проверяем, не является ли изображение пустым
          if (isImageEmpty(this) && this.src !== placeholderUrl && !this.src.includes('wikitide')) {
            this.src = placeholderUrl;
            // Для placeholder используем contain, чтобы изображение полностью помещалось по высоте
            this.style.objectFit = 'contain';
            this.style.objectPosition = 'center';
          }
          // Если это placeholder, устанавливаем contain
          if (this.src.includes('wikitide')) {
            this.style.objectFit = 'contain';
            this.style.objectPosition = 'center';
          }
        });
      }
    });
  }
  
  // Устанавливаем обработчики при загрузке
  setupImageErrorHandlers();
  
  // Также устанавливаем обработчики после динамических изменений
  const observer = new MutationObserver(function(mutations) {
    setupImageErrorHandlers();
  });
  
  const roster = document.getElementById('roster');
  const lineup = document.getElementById('lineup');
  if (roster) {
    observer.observe(roster, { childList: true, subtree: true });
  }
  if (lineup) {
    observer.observe(lineup, { childList: true, subtree: true });
  }
});
</script>
{% endblock %}
