{% extends "base.html" %}
{% block title %}{{ title or "EPL Fantasy Draft — Состояние драфта" }}{% endblock %}
{% block content %}

<div class="page">
  <div class="topbar">
    <div class="topbar-left">
      <h1 class="page-title">{{ title or "Состояние драфта" }}</h1>
      <div class="meta">
        {% if draft_completed %}
          <span class="badge badge-muted">Драфт завершён</span>
        {% else %}
          {% if next_user %}
            Сейчас пик: <strong>{{ next_user }}</strong>{% if next_round %}, Раунд {{ next_round }}{% endif %}
          {% else %}
            <span class="badge badge-muted">Идёт драфт</span>
          {% endif %}
        {% endif %}
      </div>
    </div>
    <div class="topbar-right">
      <a class="btn" href="{{ draft_url or url_for('epl.index') }}">Вернуться к драфту</a>
    </div>
  </div>

  {# ---- Сводка по ограничениям/правилам, если переданы ---- #}
  {% set limits = limits or rules or draft_limits %}
  {% if limits %}
    <div class="card">
      <div class="card-title">Ограничения драфта</div>
      <div class="card-body">
        <ul class="bullets">
          {% for k,v in limits.items() %}
            <li><strong>{{ k }}</strong>: {{ v }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endif %}

  {# ---- Таблица пиков по раундам, если есть ---- #}
  {% set picks = picks or draft_picks or picks_by_round %}
  {% if picks %}
    <div class="card">
      <div class="card-title">Пики по раундам</div>
      <div class="table-wrap">
        <table class="tbl">
          <thead>
            <tr>
              <th class="num">Раунд</th>
              <th>Драфтер</th>
              <th>Игрок</th>
              <th>Клуб</th>
              <th>Позиция</th>
              <th class="num">Время</th>
            </tr>
          </thead>
          <tbody>
            {% for row in picks %}
              <tr>
                <td class="num">{{ row.round or row.get('round') }}</td>
                <td>{{ row.user or row.manager or row.get('user') or row.get('manager') }}</td>
                <td>{{ row.player_name or row.fullName or row.get('player') }}</td>
                <td>{{ row.club or row.clubName }}</td>
                <td>{{ row.pos or row.position }}</td>
                <td class="num">
                  {% set ts = row.ts or row.timestamp %}
                  {{ ts if ts else '' }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {# ---- Составы по менеджерам (если переданы) ---- #}
  {% set squads = squads or teams or squads_by_manager %}
  {% if squads %}
    <div class="card">
      <div class="card-title">Составы по менеджерам</div>
      <div class="grid">
        {% for manager, roster in (squads.items() if squads.items is defined else squads) %}
          <div class="panel">
            <div class="panel-title">{{ manager }}</div>
            {% if roster %}
              <ul class="bullets">
                {% for p in roster %}
                  <li>{{ p.fullName or p.name or p.player_name }} — {{ p.position or p.pos }}{% if p.clubName or p.club %} ({{ p.clubName or p.club }}){% endif %}</li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="muted">Пока пусто</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {# ---- Если нет ни одного блока данных ---- #}
  {% if not limits and not picks and not squads %}
    <div class="muted">Пока нет данных для отображения. Проверь логику формирования контекста во вьюхе страницы статуса.</div>
  {% endif %}
</div>

<style>
  .page { max-width: 960px; margin: 0 auto; padding: 0 16px; }
  .topbar { display: flex; gap: 16px; align-items: flex-start; justify-content: space-between; margin: 8px 0 12px; }
  .topbar-left { display: flex; flex-direction: column; gap: 8px; min-width: 0; }
  .topbar-right { display: flex; align-items: center; gap: 10px; }
  .page-title { margin: 0; font-size: 20px; line-height: 1.2; }

  .btn { display:inline-block; padding:8px 12px; border-radius:8px; border:1px solid #d7d7d7; background:#fff; text-decoration:none; color:#111; }
  .btn:hover { background:#f6f7fb; }

  .badge { background:#222; color:#fff; border-radius:999px; padding:2px 10px; font-size:12px; }
  .badge-muted { background:#f0f0f0; color:#555; padding:4px 8px; border-radius: 8px; }
  .muted { color:#666; }

  .card { border:1px solid #ececec; border-radius:10px; margin:14px 0; overflow: hidden; }
  .card-title { background:#f6f7fb; padding:10px 12px; font-weight:600; border-bottom:1px solid #e6e6e6; }
  .card-body { padding:10px 12px; }

  .table-wrap { overflow:auto; }
  table.tbl { width:100%; border-collapse: separate; border-spacing: 0; font-size:14px; }
  table.tbl thead th { text-align:left; background:#f6f7fb; padding:10px 12px; border-bottom:1px solid #e6e6e6; position:sticky; top:0; z-index:1; }
  table.tbl td { padding:12px 12px; border-bottom:1px solid #f0f0f0; vertical-align:middle; }
  table.tbl td.num, table.tbl th.num { text-align:right; }
  table.tbl tbody tr:nth-child(odd)  { background:#fafafa; }
  table.tbl tbody tr:nth-child(even) { background:#f5f7fb; }

  .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:12px; padding:12px; }
  .panel { border:1px solid #ececec; border-radius:10px; }
  .panel-title { padding:10px 12px; background:#fafafa; border-bottom:1px solid #f0f0f0; font-weight:600; }
  .bullets { margin:0; padding:10px 16px; list-style:disc; }
  .bullets li { margin:4px 0; }
</style>

{% endblock %}
