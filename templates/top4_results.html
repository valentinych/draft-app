{% extends "base.html" %}
{% block title %}Результаты{% endblock %}
{% block content %}
<h1 class="title">Результаты</h1>
{% if session.get('godmode') %}
<div class="mb-4">
  <button class="button is-info" id="refresh-stats-btn">Пересобрать статистику</button>
  <div id="refresh-status" class="mt-2"></div>
</div>
{% endif %}
<div id="lineups-container">Загрузка...</div>

<div id="points-modal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Очки по GW</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body" id="points-modal-body"></section>
    <footer class="modal-card-foot">
      <button class="button" id="points-modal-close">Закрыть</button>
    </footer>
  </div>
</div>

<style>
  #lineups-container { display:inline-block; }
  #lineups-container .tabs { display:flex; }
  #lineups-container .tabs ul { flex-grow:0; }
  .player-row { display:flex; justify-content:space-between; align-items:center; white-space:nowrap; }
  .player-name { overflow:hidden; text-overflow:ellipsis; margin-right:6px; }
  .points-box { background:#add8e6; border-radius:4px; padding:0 6px; min-width:2em; text-align:center; cursor:pointer; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const container = document.getElementById('lineups-container');
  container.style.display = 'inline-block';
  const modal = document.getElementById('points-modal');
  const modalBody = document.getElementById('points-modal-body');
  const closeModal = () => modal.classList.remove('is-active');
  modal.querySelector('.modal-background').addEventListener('click', closeModal);
  modal.querySelector('.delete').addEventListener('click', closeModal);
  document.getElementById('points-modal-close').addEventListener('click', closeModal);
  const url = `{{ url_for('top4.results_data') }}`;

  const posOrder = { GKP:0, GK:0, G:0, DEF:1, D:1, MID:2, M:2, FWD:3, F:3 };

  // Club logo mapping using real MantraFootball S3 URLs
  const getClubLogo = (clubName) => {
    if (!clubName) return null;
    
    // Real MantraFootball club logo mapping
    const clubLogos = {
      // Bundesliga
      'Бавария': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/bayern_munich.png',
      'Боруссия Д': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/borussia_dortmund.png',
      'РБ Лейпциг': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/rb_leipzig.png',
      'Байер 04': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/bayer_leverkusen.png',
      'Айнтрахт Ф': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/eintracht_frankfurt.png',
      'Хоффенхайм': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/hoffenheim.png',
      'Санкт-Паули': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/st_pauli.png',
      'Унион Берлин': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/union_berlin.png',
      'Вольфсбург': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/wolfsburg.png',
      'Фрайбург': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/freiburg.png',
      
      // EPL  
      'Манчестер Сити': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/manchester_city.png',
      'Арсенал': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/arsenal.png',
      'Ливерпуль': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/liverpool.png',
      'Челси': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/chelsea.png',
      'Манчестер Юнайтед': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/manchester_united.png',
      'Тоттенхэм': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/tottenham.png',
      'Ноттингем Форест': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/nottingham_forest.png',
      'Кристал Пэлас': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/crystal_palace.png',
      'Вест Хэм': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/west_ham.png',
      'Ньюкасл': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/newcastle.png',
      
      // La Liga
      'Реал Мадрид': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/real_madrid.png',
      'Барселона': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/barcelona.png',
      'Атлетико': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/atletico_madrid.png',
      'Атлетик': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/athletic_bilbao.png',
      'Севилья': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/sevilla.png',
      'Бетис': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/real_betis.png',
      'Вильярреал': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/villarreal.png',
      'Валенсия': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/valencia.png',
      
      // Serie A
      'Интер': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/inter.png',
      'Милан': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/milan.png',
      'Ювентус': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/juventus.png',
      'Наполи': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/napoli.png',
      'Рома': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/roma.png',
      'Лацио': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/lazio.png',
      'Аталанта': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/atalanta.png',
      'Фиорентина': 'https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/fiorentina.png'
    };
    
    // Try exact match first
    if (clubLogos[clubName]) {
      return clubLogos[clubName];
    }
    
    // Try to construct MantraFootball URL from club name
    const normalizedName = clubName.toLowerCase()
      .replace(/\s+/g, '_')
      .replace(/[^a-z0-9_]/g, '');
    return `https://mantrafootball.s3-eu-west-1.amazonaws.com/club_logo/${normalizedName}.png`;
  };

  // Godmode functionality
  {% if session.get('godmode') %}
  const refreshBtn = document.getElementById('refresh-stats-btn');
  const refreshStatus = document.getElementById('refresh-status');
  
  refreshBtn.addEventListener('click', () => {
    refreshBtn.disabled = true;
    refreshBtn.textContent = 'Обновление...';
    refreshStatus.innerHTML = '<span class="tag is-info">Обновление статистики...</span>';
    
    fetch('{{ url_for("top4.refresh_stats") }}', {
      method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        refreshStatus.innerHTML = `<span class="tag is-success">Обновлено ${data.refreshed} из ${data.total} игроков</span>`;
        // Reload results to reflect changes
        fetch(url).then(r => r.json()).then(render);
      } else {
        refreshStatus.innerHTML = `<span class="tag is-danger">Ошибка: ${data.error}</span>`;
      }
    })
    .catch(err => {
      console.error('Error refreshing stats:', err);
      refreshStatus.innerHTML = '<span class="tag is-danger">Ошибка при обновлении статистики</span>';
    })
    .finally(() => {
      refreshBtn.disabled = false;
      refreshBtn.textContent = 'Пересобрать статистику';
    });
  });
  {% endif %}

  const showPopup = p => {
    modalBody.innerHTML = '';
    modal.querySelector('.modal-card-title').textContent = 'Очки по GW';
    const gw = [];
    const extra = [];
    (p.breakdown || []).forEach(it => {
      if (String(it.label).startsWith('GW')) gw.push(it);
      else extra.push(it);
    });
    if (gw.length) {
      const table = document.createElement('table');
      table.className = 'table is-narrow';
      const tbody = document.createElement('tbody');
      let total = 0;
      gw.forEach(it => {
        const tr = document.createElement('tr');
        const tdL = document.createElement('td');
        tdL.textContent = it.label;
        const tdP = document.createElement('td');
        tdP.className = 'has-text-right';
        tdP.textContent = it.points;
        tr.appendChild(tdL);
        tr.appendChild(tdP);
        tbody.appendChild(tr);
        total += it.points;
      });
      const totalRow = document.createElement('tr');
      const tdTL = document.createElement('td');
      tdTL.innerHTML = '<strong>Итого</strong>';
      const tdTP = document.createElement('td');
      tdTP.className = 'has-text-right';
      tdTP.innerHTML = `<strong>${total}</strong>`;
      totalRow.appendChild(tdTL);
      totalRow.appendChild(tdTP);
      tbody.appendChild(totalRow);
      table.appendChild(tbody);
      modalBody.appendChild(table);
    } else {
      modalBody.textContent = 'Нет данных';
    }
    if (extra.length) {
      const hr = document.createElement('hr');
      hr.className = 'my-2';
      modalBody.appendChild(hr);
      const pTitle = document.createElement('p');
      pTitle.innerHTML = '<strong>Неучтенные раунды</strong>';
      modalBody.appendChild(pTitle);
      const table2 = document.createElement('table');
      table2.className = 'table is-narrow';
      const tbody2 = document.createElement('tbody');
      let extraTotal = 0;
      extra.forEach(it => {
        const tr = document.createElement('tr');
        const tdL = document.createElement('td');
        tdL.textContent = it.label;
        const tdP = document.createElement('td');
        tdP.className = 'has-text-right';
        tdP.textContent = it.points;
        tr.appendChild(tdL);
        tr.appendChild(tdP);
        tbody2.appendChild(tr);
        extraTotal += it.points;
      });
      const trTotal = document.createElement('tr');
      const tdL2 = document.createElement('td');
      tdL2.innerHTML = '<strong>Сумма</strong>';
      const tdP2 = document.createElement('td');
      tdP2.className = 'has-text-right';
      tdP2.innerHTML = `<strong>${extraTotal}</strong>`;
      trTotal.appendChild(tdL2);
      trTotal.appendChild(tdP2);
      tbody2.appendChild(trTotal);
      table2.appendChild(tbody2);
      modalBody.appendChild(table2);
    }
    modal.classList.add('is-active');
  };

  const render = data => {
    const managers = data.managers || [];
    const lineups = data.lineups || {};
    container.innerHTML = '';

    const tabs = document.createElement('div');
    tabs.className = 'tabs';
    const ul = document.createElement('ul');
    ul.style.flexGrow = '0';
    tabs.appendChild(ul);

    const contents = document.createElement('div');
    contents.style.display = 'block';

    managers.forEach((m, idx) => {
      const li = document.createElement('li');
      if (idx === 0) li.classList.add('is-active');
      const a = document.createElement('a');
      const nameStrong = document.createElement('strong');
      nameStrong.textContent = m;
      a.appendChild(nameStrong);
      const total = lineups[m] && lineups[m].total;
      if (total !== undefined && total !== null) {
        const span = document.createElement('span');
        span.style.backgroundColor = '#006400';
        span.style.color = 'white';
        span.style.padding = '0 4px';
        span.style.borderRadius = '3px';
        span.style.marginLeft = '4px';
        span.textContent = total;
        a.appendChild(span);
      }
      li.appendChild(a);
      ul.appendChild(li);

      const mgrDiv = document.createElement('div');
      mgrDiv.style.display = idx === 0 ? 'block' : 'none';
      const players = (lineups[m] && lineups[m].players) || [];
      const hue = idx * 60;
      const c1 = `hsl(${hue}, 70%, 90%)`;
      const c2 = `hsl(${hue}, 70%, 80%)`;
      players.sort((a, b) => {
        const pa = (a.pos || '').toUpperCase();
        const pb = (b.pos || '').toUpperCase();
        return (posOrder[pa] ?? 99) - (posOrder[pb] ?? 99);
      });
      let lastPos = null;
      players.forEach((p, j) => {
        if (lastPos && p.pos !== lastPos) {
          const hr = document.createElement('hr');
          hr.className = 'my-1';
          mgrDiv.appendChild(hr);
        }
        lastPos = p.pos;
        const row = document.createElement('div');
        row.className = 'player-row';
        row.style.backgroundColor = j % 2 === 0 ? c1 : c2;
        const spanName = document.createElement('span');
        spanName.className = 'player-name';
        
        // Try to show club logo
        let logoShown = false;
        if (p.logo) {
          // Use MantraFootball logo if available
          const img = document.createElement('img');
          img.src = p.logo;
          img.alt = '';
          img.style.height = '1em';
          img.style.marginRight = '4px';
          img.onerror = () => {
            // If MantraFootball logo fails, try club-based logo
            const fallbackLogo = getClubLogo(p.club);
            if (fallbackLogo) {
              img.src = fallbackLogo;
            } else {
              img.style.display = 'none';
            }
          };
          spanName.appendChild(img);
          logoShown = true;
        } else if (p.club) {
          // Use club-based logo as fallback
          const fallbackLogo = getClubLogo(p.club);
          if (fallbackLogo) {
            const img = document.createElement('img');
            img.src = fallbackLogo;
            img.alt = p.club;
            img.style.height = '1em';
            img.style.marginRight = '4px';
            img.onerror = () => {
              img.style.display = 'none';
            };
            spanName.appendChild(img);
            logoShown = true;
          }
        }
        
        spanName.appendChild(document.createTextNode(p.name));
        const spanPts = document.createElement('span');
        spanPts.className = 'points-box';
        spanPts.textContent = p.points;
        spanPts.addEventListener('click', () => showPopup(p));
        row.appendChild(spanName);
        row.appendChild(spanPts);
        mgrDiv.appendChild(row);
      });
      contents.appendChild(mgrDiv);

      li.addEventListener('click', () => {
        Array.from(ul.children).forEach((el, i) => {
          el.classList.toggle('is-active', el === li);
          const c = contents.children[i];
          if (c) c.style.display = el === li ? 'block' : 'none';
        });
      });
    });

    container.appendChild(tabs);
    container.appendChild(contents);
  };

  fetch(url)
    .then(resp => resp.json())
    .then(render)
    .catch(() => {
      container.textContent = 'Ошибка загрузки данных';
    });
});
</script>
{% endblock %}

